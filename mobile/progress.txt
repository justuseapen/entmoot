# Ralph Progress Log - Entmoot Mobile App

## Project Context
- Building React Native iOS app with Expo managed workflow
- Backend API already exists at /backend (100+ endpoints ready)
- Web frontend exists at /frontend (can reference for patterns)
- Mobile app location: /mobile

## Technical Decisions
- Using Expo SDK 52+ managed workflow
- expo-router for navigation (file-based routing)
- react-native-paper for UI components
- zustand for client state
- @tanstack/react-query for server state
- expo-secure-store for auth token storage
- MMKV for offline caching
- Session-based auth (not JWT)

## API Base URL
- Development: http://localhost:3000/api/v1
- All endpoints documented in backend/app/controllers/api/v1/

## Key Backend Endpoints
- Auth: POST /auth/login, /auth/register, /auth/logout, GET /auth/me
- Families: GET/POST /families, GET /families/:id/members
- Daily Plans: GET /families/:id/daily_plans/today, PATCH /families/:id/daily_plans/:id
- Habits: GET/POST/PATCH/DELETE /families/:id/habits
- Goals: GET/POST/PATCH/DELETE /families/:id/goals, POST /goals/:id/refine
- Reflections: GET/POST/PATCH /families/:id/reflections
- Reviews: GET /families/:id/weekly_reviews/current
- Notifications: GET /notifications, POST /device_tokens
- User: GET /users/me/points, /users/me/streaks, /users/me/badges

## Codebase Patterns
- Use /bin/bash -c '...' for commands requiring asdf node (v23+) since Expo 54 requires Node 20+
- Path aliases: @/ maps to src/, @shared maps to ../shared (configured in tsconfig.json and babel.config.js)
- Run `npx tsc --noEmit` for typecheck before committing
- iOS bundle identifier: com.entmoot.mobile
- Environment variables via react-native-dotenv: import { API_URL } from "@env"; (TypeScript types in src/types/env.d.ts)
- Jest configured with jest-expo preset; use `npm test` or `npm run test:watch`
- @env mock in __mocks__/@env.js for tests
- expo-router: File-based routing in /app directory, main entry point is "expo-router/entry" in package.json
- Design colors: primary=#4F46E5, secondary=#2D5A27, background=#FFF8E7, earthBrown=#795548
- UI components: Import from @/components/ui (Typography, Button, Card, Input, LoadingSpinner)
- Theme colors: Import COLORS from @/theme/colors for consistent styling
- Use @expo/vector-icons Ionicons for icons (already installed)
- API client: Use `api.get<T>`, `api.post<T>`, `api.patch<T>`, `api.del<T>` for typed requests with auto-auth
- QueryClient: Import from @/lib/queryClient for TanStack Query setup
- Auth store: Import useAuthStore or useAuth from @/stores; use currentFamilyId for family-scoped API calls
- Family ID persistence: setCurrentFamily(id) persists to SecureStore and updates zustand state

## Learnings
(Ralph will append learnings here as iterations progress)

---

## 2026-01-21 - US-001
- What was implemented: Completed Expo project initialization requirements
- Files changed: babel.config.js (created), app.json (updated bundle ID, iOS min version), package.json (babel-plugin-module-resolver added)
- **Learnings for future iterations:**
  - Expo 54 requires Node.js 20+; use asdf shims for correct version
  - expo-constants should NOT be in plugins array (it's not a config plugin)
  - The project already had React Navigation setup (not expo-router) - existing structure should be preserved
  - Use `/bin/bash -c '/Users/justuseapen/.asdf/shims/npx ...'` pattern for expo commands
---

## 2026-01-21 - US-002
- What was implemented: Configured development environment with testing and env variable support
- Files changed:
  - .prettierrc (extended with additional rules)
  - .env.example (created with API_URL)
  - package.json (added test scripts, jest, jest-expo, @testing-library/react-native, react-native-dotenv)
  - babel.config.js (added react-native-dotenv plugin)
  - jest.config.js (created with jest-expo preset and path aliases)
  - jest.setup.js (created for @testing-library/react-native setup)
  - src/types/env.d.ts (created TypeScript declaration for @env module)
  - __mocks__/@env.js (created mock for tests)
- **Learnings for future iterations:**
  - ESLint was already configured with TypeScript and React plugins (not @react-native/eslint-config but works)
  - Use `--legacy-peer-deps` when installing @testing-library/react-native due to React 19 peer conflicts
  - Jest setup file path must be `<rootDir>/jest.setup.js` not the package path directly
  - git root is /washington, not /washington/mobile - use relative paths when staging files
---

## 2026-01-21 - US-003
- What was implemented: Set up navigation structure with expo-router file-based routing
- Files changed:
  - app.json (added scheme, web bundler, expo-router plugin)
  - package.json (changed main to expo-router/entry, added expo-router and dependencies)
  - app/_layout.tsx (root layout with auth guard)
  - app/(auth)/_layout.tsx, login.tsx, register.tsx, forgot-password.tsx (auth screens)
  - app/(tabs)/_layout.tsx, today.tsx, goals.tsx, me.tsx (main tabs with icons)
  - app/onboarding/index.tsx, app/settings/index.tsx, app/goal/[id].tsx (stack screens)
- **Learnings for future iterations:**
  - expo-router uses app/ directory for file-based routing (not src/)
  - Use `--legacy-peer-deps` when installing packages with React 19 peer dependency conflicts
  - The existing src/navigation/ React Navigation code still exists but is not used by expo-router
  - useSegments() returns the current route segments for auth guard logic
  - Tab bar icons use @expo/vector-icons/Ionicons - import with { Ionicons } from "@expo/vector-icons"
---

## 2026-01-21 - US-004
- What was implemented: Created design system foundation with reusable UI components
- Files changed:
  - package.json (added react-native-paper)
  - app/_layout.tsx (configured PaperProvider with custom theme)
  - src/theme/colors.ts (created with brand colors and paper theme colors)
  - src/components/ui/Typography.tsx (H1, H2, H3, Body, Caption variants)
  - src/components/ui/Button.tsx (primary, secondary, outline, ghost variants)
  - src/components/ui/Card.tsx (default, outlined, elevated variants + PressableCard)
  - src/components/ui/Input.tsx (with label, error state, helper text)
  - src/components/ui/LoadingSpinner.tsx (with optional message and fullScreen mode)
  - src/components/ui/index.ts (barrel export file)
- **Learnings for future iterations:**
  - react-native-paper uses MD3LightTheme as base theme, extend colors with spread operator
  - PaperProvider must wrap the entire app tree (wrap SafeAreaProvider inside)
  - Custom UI components don't need to wrap Paper components - plain React Native works well
  - Use COLORS from @/theme/colors for consistent styling across the app
  - Button/Card variants are implemented as StyleSheet combinations, not separate components
  - Import components from @/components/ui (barrel export pattern)
---

## 2026-01-21 - US-005
- What was implemented: Created secure storage service for auth tokens and sensitive data
- Files changed:
  - package.json (expo-secure-store version updated)
  - src/services/secureStorage.ts (created with all secure storage functions)
- **Learnings for future iterations:**
  - expo-secure-store was already in package.json but at an older version - npm install updated it
  - Use `--legacy-peer-deps` when installing packages due to React 19 peer dependency conflicts
  - Import from expo-secure-store: setItemAsync, getItemAsync, deleteItemAsync (not set/get/delete)
  - STORAGE_KEYS constants help prevent typos and enable TypeScript autocomplete
  - clearAuthData() helper is useful for logout - clears all auth-related keys at once
  - Services directory is at src/services/ for platform-specific services
---

## 2026-01-21 - US-006
- What was implemented: Created API client with typed convenience methods and TanStack Query setup
- Files changed:
  - package.json (added @tanstack/react-query)
  - src/lib/api.ts (added typed get<T>, post<T>, patch<T>, del<T> methods)
  - src/lib/queryClient.ts (created with mobile-optimized defaults)
  - src/lib/index.ts (added queryClient export)
- **Learnings for future iterations:**
  - API client was already mostly implemented at src/lib/api.ts with auth token handling
  - apiClient.setOnAuthError() callback handles 401 redirects (already connected in authStore)
  - Use `api.get<T>('/endpoint')` for typed GET requests with auto-auth
  - QueryClient defaults: 5min staleTime, 30min gcTime, refetchOnWindowFocus=false (better mobile UX)
  - Config uses expo-constants to detect environment (development/staging/production)
  - API base URL comes from src/lib/config.ts, not @env module
---

## 2026-01-21 - US-007
- What was implemented: Enhanced auth store with currentFamilyId state and setCurrentFamily action
- Files changed:
  - src/stores/auth.ts (added currentFamilyId state, setCurrentFamily action, useAuth hook alias)
  - src/stores/index.ts (added useAuth export)
- **Learnings for future iterations:**
  - Auth store already existed with zustand, login/logout/register actions, and JWT token handling
  - zustand was already installed in package.json (v5.0.2)
  - The store uses custom JWT implementation with token refresh, not Rails session-based auth
  - Import useAuthStore or useAuth from @/stores - both work identically
  - currentFamilyId is persisted to SecureStore as FAMILY_ID_KEY ("entmoot_family_id")
  - setCurrentFamily action both persists to storage AND updates zustand state
  - The store already has apiClient callbacks for token refresh and auth errors
---

## 2026-01-21 - US-008
- What was implemented: Built full login screen with complete UI and functionality
- Files changed:
  - app/(auth)/login.tsx (complete rewrite with form, validation, navigation)
- **Learnings for future iterations:**
  - Use KeyboardAvoidingView with ScrollView pattern for forms with keyboard
  - Input component from @/components/ui supports error prop for validation messages
  - Button component supports loading prop which shows ActivityIndicator
  - authStore.login() is async and throws error on failure - catch and show Alert
  - Use router.replace for navigation after successful login (not push)
  - router.push for navigating to other auth screens (forgot-password, register)
  - Password show/hide toggle: position absolute TouchableOpacity with Ionicons eye icon
  - Form validation should clear errors when user starts typing in that field
  - Use hitSlop on touch targets for better accessibility
---
