# Ralph Progress Log - Entmoot Mobile App

## Project Context
- Building React Native iOS app with Expo managed workflow
- Backend API already exists at /backend (100+ endpoints ready)
- Web frontend exists at /frontend (can reference for patterns)
- Mobile app location: /mobile

## Technical Decisions
- Using Expo SDK 52+ managed workflow
- expo-router for navigation (file-based routing)
- react-native-paper for UI components
- zustand for client state
- @tanstack/react-query for server state
- expo-secure-store for auth token storage
- MMKV for offline caching
- Session-based auth (not JWT)

## API Base URL
- Development: http://localhost:3000/api/v1
- All endpoints documented in backend/app/controllers/api/v1/

## Key Backend Endpoints
- Auth: POST /auth/login, /auth/register, /auth/logout, GET /auth/me
- Families: GET/POST /families, GET /families/:id/members
- Daily Plans: GET /families/:id/daily_plans/today, PATCH /families/:id/daily_plans/:id
- Habits: GET/POST/PATCH/DELETE /families/:id/habits
- Goals: GET/POST/PATCH/DELETE /families/:id/goals, POST /goals/:id/refine
- Reflections: GET/POST/PATCH /families/:id/reflections
- Reviews: GET /families/:id/weekly_reviews/current
- Notifications: GET /notifications, POST /device_tokens
- User: GET /users/me/points, /users/me/streaks, /users/me/badges

## Codebase Patterns
- Use /bin/bash -c '...' for commands requiring asdf node (v23+) since Expo 54 requires Node 20+
- Path aliases: @/ maps to src/, @shared maps to ../shared (configured in tsconfig.json and babel.config.js)
- Run `npx tsc --noEmit` for typecheck before committing
- iOS bundle identifier: com.entmoot.mobile
- Environment variables via react-native-dotenv: import { API_URL } from "@env"; (TypeScript types in src/types/env.d.ts)
- Jest configured with jest-expo preset; use `npm test` or `npm run test:watch`
- @env mock in __mocks__/@env.js for tests
- expo-router: File-based routing in /app directory, main entry point is "expo-router/entry" in package.json
- Design colors: primary=#4F46E5, secondary=#2D5A27, background=#FFF8E7, earthBrown=#795548
- UI components: Import from @/components/ui (Typography, Button, Card, Input, LoadingSpinner)
- Theme colors: Import COLORS from @/theme/colors for consistent styling
- Use @expo/vector-icons Ionicons for icons (already installed)
- API client: Use `api.get<T>`, `api.post<T>`, `api.patch<T>`, `api.del<T>` for typed requests with auto-auth
- QueryClient: Import from @/lib/queryClient for TanStack Query setup
- Auth store: Import useAuthStore or useAuth from @/stores; use currentFamilyId for family-scoped API calls
- Family ID persistence: setCurrentFamily(id) persists to SecureStore and updates zustand state
- Services: Import from @/services (secureStorage, biometrics) for platform services
- Biometric auth: Use shouldPromptBiometric() before authenticate(); respects user preference + device capability
- Data hooks: Import useTodayPlan, useUpdateDailyPlan from @/hooks for daily plan data; uses TanStack Query with optimistic updates
- Query keys pattern: Use exported keys objects (e.g., dailyPlanKeys) for consistent cache management

## Learnings
(Ralph will append learnings here as iterations progress)

---

## 2026-01-21 - US-001
- What was implemented: Completed Expo project initialization requirements
- Files changed: babel.config.js (created), app.json (updated bundle ID, iOS min version), package.json (babel-plugin-module-resolver added)
- **Learnings for future iterations:**
  - Expo 54 requires Node.js 20+; use asdf shims for correct version
  - expo-constants should NOT be in plugins array (it's not a config plugin)
  - The project already had React Navigation setup (not expo-router) - existing structure should be preserved
  - Use `/bin/bash -c '/Users/justuseapen/.asdf/shims/npx ...'` pattern for expo commands
---

## 2026-01-21 - US-002
- What was implemented: Configured development environment with testing and env variable support
- Files changed:
  - .prettierrc (extended with additional rules)
  - .env.example (created with API_URL)
  - package.json (added test scripts, jest, jest-expo, @testing-library/react-native, react-native-dotenv)
  - babel.config.js (added react-native-dotenv plugin)
  - jest.config.js (created with jest-expo preset and path aliases)
  - jest.setup.js (created for @testing-library/react-native setup)
  - src/types/env.d.ts (created TypeScript declaration for @env module)
  - __mocks__/@env.js (created mock for tests)
- **Learnings for future iterations:**
  - ESLint was already configured with TypeScript and React plugins (not @react-native/eslint-config but works)
  - Use `--legacy-peer-deps` when installing @testing-library/react-native due to React 19 peer conflicts
  - Jest setup file path must be `<rootDir>/jest.setup.js` not the package path directly
  - git root is /washington, not /washington/mobile - use relative paths when staging files
---

## 2026-01-21 - US-003
- What was implemented: Set up navigation structure with expo-router file-based routing
- Files changed:
  - app.json (added scheme, web bundler, expo-router plugin)
  - package.json (changed main to expo-router/entry, added expo-router and dependencies)
  - app/_layout.tsx (root layout with auth guard)
  - app/(auth)/_layout.tsx, login.tsx, register.tsx, forgot-password.tsx (auth screens)
  - app/(tabs)/_layout.tsx, today.tsx, goals.tsx, me.tsx (main tabs with icons)
  - app/onboarding/index.tsx, app/settings/index.tsx, app/goal/[id].tsx (stack screens)
- **Learnings for future iterations:**
  - expo-router uses app/ directory for file-based routing (not src/)
  - Use `--legacy-peer-deps` when installing packages with React 19 peer dependency conflicts
  - The existing src/navigation/ React Navigation code still exists but is not used by expo-router
  - useSegments() returns the current route segments for auth guard logic
  - Tab bar icons use @expo/vector-icons/Ionicons - import with { Ionicons } from "@expo/vector-icons"
---

## 2026-01-21 - US-004
- What was implemented: Created design system foundation with reusable UI components
- Files changed:
  - package.json (added react-native-paper)
  - app/_layout.tsx (configured PaperProvider with custom theme)
  - src/theme/colors.ts (created with brand colors and paper theme colors)
  - src/components/ui/Typography.tsx (H1, H2, H3, Body, Caption variants)
  - src/components/ui/Button.tsx (primary, secondary, outline, ghost variants)
  - src/components/ui/Card.tsx (default, outlined, elevated variants + PressableCard)
  - src/components/ui/Input.tsx (with label, error state, helper text)
  - src/components/ui/LoadingSpinner.tsx (with optional message and fullScreen mode)
  - src/components/ui/index.ts (barrel export file)
- **Learnings for future iterations:**
  - react-native-paper uses MD3LightTheme as base theme, extend colors with spread operator
  - PaperProvider must wrap the entire app tree (wrap SafeAreaProvider inside)
  - Custom UI components don't need to wrap Paper components - plain React Native works well
  - Use COLORS from @/theme/colors for consistent styling across the app
  - Button/Card variants are implemented as StyleSheet combinations, not separate components
  - Import components from @/components/ui (barrel export pattern)
---

## 2026-01-21 - US-005
- What was implemented: Created secure storage service for auth tokens and sensitive data
- Files changed:
  - package.json (expo-secure-store version updated)
  - src/services/secureStorage.ts (created with all secure storage functions)
- **Learnings for future iterations:**
  - expo-secure-store was already in package.json but at an older version - npm install updated it
  - Use `--legacy-peer-deps` when installing packages due to React 19 peer dependency conflicts
  - Import from expo-secure-store: setItemAsync, getItemAsync, deleteItemAsync (not set/get/delete)
  - STORAGE_KEYS constants help prevent typos and enable TypeScript autocomplete
  - clearAuthData() helper is useful for logout - clears all auth-related keys at once
  - Services directory is at src/services/ for platform-specific services
---

## 2026-01-21 - US-006
- What was implemented: Created API client with typed convenience methods and TanStack Query setup
- Files changed:
  - package.json (added @tanstack/react-query)
  - src/lib/api.ts (added typed get<T>, post<T>, patch<T>, del<T> methods)
  - src/lib/queryClient.ts (created with mobile-optimized defaults)
  - src/lib/index.ts (added queryClient export)
- **Learnings for future iterations:**
  - API client was already mostly implemented at src/lib/api.ts with auth token handling
  - apiClient.setOnAuthError() callback handles 401 redirects (already connected in authStore)
  - Use `api.get<T>('/endpoint')` for typed GET requests with auto-auth
  - QueryClient defaults: 5min staleTime, 30min gcTime, refetchOnWindowFocus=false (better mobile UX)
  - Config uses expo-constants to detect environment (development/staging/production)
  - API base URL comes from src/lib/config.ts, not @env module
---

## 2026-01-21 - US-007
- What was implemented: Enhanced auth store with currentFamilyId state and setCurrentFamily action
- Files changed:
  - src/stores/auth.ts (added currentFamilyId state, setCurrentFamily action, useAuth hook alias)
  - src/stores/index.ts (added useAuth export)
- **Learnings for future iterations:**
  - Auth store already existed with zustand, login/logout/register actions, and JWT token handling
  - zustand was already installed in package.json (v5.0.2)
  - The store uses custom JWT implementation with token refresh, not Rails session-based auth
  - Import useAuthStore or useAuth from @/stores - both work identically
  - currentFamilyId is persisted to SecureStore as FAMILY_ID_KEY ("entmoot_family_id")
  - setCurrentFamily action both persists to storage AND updates zustand state
  - The store already has apiClient callbacks for token refresh and auth errors
---

## 2026-01-21 - US-008
- What was implemented: Built full login screen with complete UI and functionality
- Files changed:
  - app/(auth)/login.tsx (complete rewrite with form, validation, navigation)
- **Learnings for future iterations:**
  - Use KeyboardAvoidingView with ScrollView pattern for forms with keyboard
  - Input component from @/components/ui supports error prop for validation messages
  - Button component supports loading prop which shows ActivityIndicator
  - authStore.login() is async and throws error on failure - catch and show Alert
  - Use router.replace for navigation after successful login (not push)
  - router.push for navigating to other auth screens (forgot-password, register)
  - Password show/hide toggle: position absolute TouchableOpacity with Ionicons eye icon
  - Form validation should clear errors when user starts typing in that field
  - Use hitSlop on touch targets for better accessibility
---

## 2026-01-21 - US-009
- What was implemented: Built full registration screen with complete form and error handling
- Files changed:
  - app/(auth)/register.tsx (complete rewrite with registration form UI)
- **Learnings for future iterations:**
  - Registration uses authStore.register() which handles saving tokens and user state automatically
  - RegisterData type from @shared/types requires: name, email, password, password_confirmation
  - API validation errors may come as JSON with field-level errors (email, password, name, password_confirmation arrays)
  - Use router.back() for "Log In" link since register is pushed from login screen
  - Both password fields have show/hide toggles - use separate state (showPassword, showConfirmPassword)
  - autoComplete="new-password" for registration password fields (vs "password" for login)
  - helperText prop on Input component shows text below input (used for password requirements)
---

## 2026-01-21 - US-010
- What was implemented: Built forgot password screen with email reset functionality
- Files changed:
  - app/(auth)/forgot-password.tsx (complete rewrite with forgot password form)
- **Learnings for future iterations:**
  - Use apiFetch for unauthenticated API calls (password reset doesn't require auth)
  - Success alert uses array of buttons to navigate user back to login
  - COLORS.text is the correct color for primary text (not textPrimary which doesn't exist)
  - Generic success message avoids revealing whether email exists in system (security best practice)
  - Back button with Ionicons arrow-back provides clear navigation affordance
---

## 2026-01-21 - US-011
- What was implemented: Biometric authentication with Face ID/Touch ID support
- Files changed:
  - package.json (added expo-local-authentication)
  - src/services/biometrics.ts (created with all biometric functions)
  - src/services/index.ts (created barrel export for services)
  - app/_layout.tsx (updated AuthGuard for biometric prompt on foreground)
- **Learnings for future iterations:**
  - expo-local-authentication uses SecurityLevel enum (BIOMETRIC_STRONG, BIOMETRIC_WEAK) for capability check
  - Use AuthenticationType enum (FACIAL_RECOGNITION, FINGERPRINT) to determine biometric type
  - AppState API with addEventListener "change" detects foreground/background transitions
  - Use useRef for appState and biometricPromptShown to avoid unnecessary re-renders
  - shouldPromptBiometric helper combines availability check + preference check + session check
  - biometricLocked state prevents navigation while biometric prompt is active
  - Services barrel export at src/services/index.ts enables cleaner imports
---

## 2026-01-21 - US-012
- What was implemented: Built onboarding welcome flow with 4 swipeable pages
- Files changed:
  - package.json (added react-native-pager-view)
  - app/onboarding/index.tsx (complete rewrite with PagerView for swiping)
- **Learnings for future iterations:**
  - react-native-pager-view requires --legacy-peer-deps due to React 19 peer dependency conflicts
  - PagerView uses onPageSelected callback with e.nativeEvent.position for page tracking
  - Use useRef<PagerView> with pagerRef.current.setPage(n) for programmatic navigation
  - Page indicators: active indicator can be wider (24px vs 8px) for visual emphasis
  - Ionicons provides good icons for onboarding: leaf, sunny, checkmark-circle, trophy
  - router.push is correct for onboarding â†’ family-setup navigation (not replace)
  - SafeAreaView needed for proper spacing on devices with notch
---

## 2026-01-21 - US-013
- What was implemented: Built family setup screen with create/join family options
- Files changed:
  - package.json (added expo-localization)
  - app.json (added expo-localization plugin)
  - app/onboarding/family-setup.tsx (created - full implementation)
- **Learnings for future iterations:**
  - expo-localization uses getCalendars()[0].timeZone for timezone detection (not Localization.timezone)
  - PressableCard from @/components/ui is perfect for selectable option cards
  - Use mode state pattern ("select" | "create" | "join") for multi-step forms with back navigation
  - api.post<T> from @/lib/api handles auth automatically and returns typed response
  - setCurrentFamily(id) from authStore persists to SecureStore and updates zustand state
  - router.replace('/(tabs)/today') for navigation after family setup (no back option)
---

## 2026-01-21 - US-014
- What was implemented: Built First Goal Prompt modal component for new user onboarding
- Files changed:
  - src/components/FirstGoalPrompt.tsx (created - modal component with suggestion cards)
  - app/(tabs)/today.tsx (integrated FirstGoalPrompt with eligibility check)
- **Learnings for future iterations:**
  - Use Modal with presentationStyle="pageSheet" for native iOS sheet-style modals
  - Create companion hook (useFirstGoalPrompt) alongside modal component for eligibility checking
  - PressableCard variant="elevated" with custom borderColor for selected state looks good
  - Radio-style selection UI: radioCircle with inner filled circle on selection
  - Custom goal mode: switch from suggestions to TextInput with back navigation
  - KeyboardAvoidingView with behavior="padding" on iOS for forms in modals
  - Default suggestions as fallback when API doesn't return suggestions or errors
  - isCustomMode state pattern for toggling between selection and input modes
  - API endpoints: GET /users/me/first_goal_prompt (eligibility), POST /users/me/first_goal_prompt/dismiss (dismiss)
---

## 2026-01-21 - US-015
- What was implemented: Created daily plan data layer with hooks for fetching and updating daily plans
- Files changed:
  - src/hooks/useDailyPlan.ts (created - all types and hooks)
  - src/hooks/index.ts (updated - export new hooks and types)
- **Learnings for future iterations:**
  - Daily plan API uses nested attributes pattern: daily_tasks_attributes, top_priorities_attributes, habit_completions_attributes
  - TanStack Query optimistic updates: use onMutate to snapshot and update cache, onError to rollback, onSuccess to sync with server
  - Query keys pattern: dailyPlanKeys.today(familyId) enables easy invalidation and cache management
  - HabitCompletion has nested habit info (habit.name, habit.position, habit.is_active)
  - CompletionStats provides task/priority/habit completion counts for progress display
  - _destroy: true in nested attributes tells Rails to delete the record
  - Use Date.now() as temporary ID for optimistic new items (server will replace with real ID)
  - useAuthStore((state) => state.currentFamilyId) for accessing family ID in hooks
---

## 2026-01-21 - US-016
- What was implemented: Built Today Screen Header with date, greeting, and completion stats
- Files changed:
  - package.json (added date-fns)
  - app/(tabs)/today.tsx (complete rewrite with header section)
- **Learnings for future iterations:**
  - date-fns format() with "EEEE, MMMM d" gives "Wednesday, January 22" format
  - Use SafeAreaView edges={["top"]} for screens with custom headers (not system header)
  - RefreshControl: use refreshing={isFetching && !isLoading} to avoid showing spinner on initial load
  - Skeleton components: simple Views with backgroundColor matching COLORS.surface look good
  - CompletionStats from daily plan has tasks_total, tasks_completed, priorities_total, priorities_completed, habits_total, habits_completed
  - User name available via useAuthStore((state) => state.user?.name)
---
