{
  "project": "Entmoot",
  "branchName": "ralph/mentions-weekly-review-redesign",
  "description": "Add @mention functionality, fix goal linking UI, and redesign weekly review to match Apple Notes template system",
  "userStories": [
    {
      "id": "US-001",
      "title": "Fix goal link button clickability in Daily Planner",
      "description": "As a user, I want to click the link icon to select a goal for my top priority.",
      "acceptanceCriteria": [
        "Investigate SelectTrigger size='sm' prop - may need to remove or adjust",
        "Ensure link icon button has proper clickable area (padding, min-width)",
        "Ensure dropdown opens when clicking the link icon",
        "Test on mobile and desktop viewports",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Fixed by removing size=sm prop, increasing width to w-11 (44px), height to h-10 (40px), and reducing padding to px-2 for proper touch targets. Added aria-label for accessibility."
    },
    {
      "id": "US-002",
      "title": "Add new fields to WeeklyReview model for template sections",
      "description": "As a developer, I need database fields matching the new weekly review template structure.",
      "acceptanceCriteria": [
        "Add migration for weekly_reviews table with new fields:",
        "- source_review_completed (boolean, default false)",
        "- wins_shipped (text) - replaces 'wins'",
        "- losses_friction (text) - replaces 'challenges'",
        "- workouts_completed (integer)",
        "- workouts_planned (integer)",
        "- walks_completed (integer)",
        "- walks_planned (integer, default 7)",
        "- writing_sessions_completed (integer)",
        "- writing_sessions_planned (integer)",
        "- house_resets_completed (integer)",
        "- house_resets_planned (integer, default 7)",
        "- meals_prepped_held (boolean)",
        "- metrics_notes (text)",
        "- daily_focus_used_every_day (boolean)",
        "- weekly_priorities_clear (boolean)",
        "- cleaning_system_held (boolean)",
        "- training_volume_sustainable (boolean)",
        "- system_to_adjust (text)",
        "- weekly_priorities (text) - replaces 'next_week_priorities'",
        "- kill_list (text) - explicit neglect items",
        "- workouts_blocked (boolean, default false)",
        "- monday_top_3_decided (boolean, default false)",
        "- monday_focus_card_prepped (boolean, default false)",
        "Keep existing: week_start_date, user_id, family_id, completed, created_at, updated_at",
        "Remove or deprecate: wins, challenges, next_week_priorities, lessons_learned",
        "Run migration successfully",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Added migration with all 21 new fields for template sections. Old jsonb columns (wins, challenges, next_week_priorities) and lessons_learned kept for backward compatibility. System health check booleans are intentionally nullable (nil = unanswered). All 51 WeeklyReview tests pass."
    },
    {
      "id": "US-003",
      "title": "Update WeeklyReview API to support new fields",
      "description": "As a developer, I need the API to accept and return the new weekly review fields.",
      "acceptanceCriteria": [
        "Update weekly_reviews_controller to permit all new params",
        "Update serializer/JSON response to include all new fields",
        "Maintain backward compatibility for any existing reviews",
        "Write request specs for create/update with new fields",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Added all 21 new template fields to permitted params and JSON response. Refactored controller into smaller helper methods for rubocop compliance. All 38 request specs pass including 7 new tests for template fields."
    },
    {
      "id": "US-004",
      "title": "Update frontend WeeklyReview type",
      "description": "As a developer, I need TypeScript types for the new weekly review structure.",
      "acceptanceCriteria": [
        "Update WeeklyReview type in frontend with all new fields",
        "Match field names exactly with backend (snake_case from API)",
        "Add proper types (number, boolean, string | null)",
        "Update useWeeklyReview hook if needed",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Updated WeeklyReview and UpdateWeeklyReviewData interfaces in frontend/src/lib/weeklyReviews.ts with all 21 new template fields. Used nullable types (| null) for optional fields that can be unanswered. Forward setup booleans are non-nullable (default false). TypeScript build passes."
    },
    {
      "id": "US-005",
      "title": "Create new WeeklyReview UI - Section 0: Source Review",
      "description": "As a user, I want to see a reminder to review my Daily Focus Cards before starting.",
      "acceptanceCriteria": [
        "Add Section 0 card with header 'Source Review (Non-negotiable)'",
        "Display instruction text: 'Before writing anything below: Lay out all Daily Focus Cards from the week (or open the daily notes). Do not rely on memory. Tally first, reflect second.'",
        "Add checkbox for source_review_completed",
        "Display list/links to this week's daily plans (7 cards)",
        "Section appears first, before all other sections",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Added Section 0 card with amber styling, 7-day calendar grid showing links to existing daily plans or placeholders for missing days, and auto-saving checkbox. Backend updated to include daily_plans summary in API response. TypeScript build passes."
    },
    {
      "id": "US-006",
      "title": "Create Section 1: Review (Evidence-based)",
      "description": "As a user, I want to record wins and losses from the week.",
      "acceptanceCriteria": [
        "Add Section 1 card with header 'Review (Evidence-based)'",
        "Two textarea fields:",
        "  - 'Wins (things that shipped or moved forward)' -> wins_shipped",
        "  - 'Losses / Friction' -> losses_friction",
        "Both fields are multiline textareas",
        "Auto-save on blur",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Added Section 1 card with ClipboardList icon, two auto-saving textareas (wins_shipped and losses_friction). Uses onBlur for auto-save. TypeScript build passes."
    },
    {
      "id": "US-007",
      "title": "Create Section 2: Metrics Snapshot",
      "description": "As a user, I want to tally habit completion from my Daily Focus Cards.",
      "acceptanceCriteria": [
        "Add Section 2 card with header 'Metrics Snapshot (Tally from Daily Cards)'",
        "Input pairs for each metric (completed / planned):",
        "  - Workouts completed ___ / planned ___",
        "  - Daily walks completed ___ / 7",
        "  - Writing sessions completed ___ / planned ___",
        "  - House reset completed ___ / 7",
        "  - Meals prepped / system held: Y/N checkbox",
        "Textarea for 'Notes (only if something broke)' -> metrics_notes",
        "Display completion percentages next to each metric",
        "Auto-save on blur",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Added Section 2 card with Activity icon, 4 metric rows (workouts, walks, writing, house resets) with completed/planned input pairs and percentage display. Includes meals prepped Y/N toggle and metrics notes textarea. Auto-saves on blur. TypeScript build passes."
    },
    {
      "id": "US-008",
      "title": "Create Section 3: System Health Check",
      "description": "As a user, I want to quickly assess if my systems are working.",
      "acceptanceCriteria": [
        "Add Section 3 card with header 'System Health Check (Yes / No)'",
        "Instruction text: 'Answer quickly. No explanations unless No.'",
        "Y/N toggle buttons for each question:",
        "  - Daily Focus Card used every day?",
        "  - Weekly priorities were clear by Monday?",
        "  - Cleaning system held without resentment?",
        "  - Training volume felt sustainable?",
        "Show textarea 'If any No, name the system to adjust:' only if any answer is No",
        "Auto-save on change",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Added Section 3 card with HeartPulse icon and rose color theme. Four Y/N toggle buttons for health check questions with auto-save on change. Conditional textarea appears only when any answer is No. TypeScript build passes."
    },
    {
      "id": "US-009",
      "title": "Create Section 4: This Week's Priorities",
      "description": "As a user, I want to set max 5 priorities that advance quarterly objectives.",
      "acceptanceCriteria": [
        "Add Section 4 card with header 'This Week's Priorities (Max 5)'",
        "Display rule text: 'Each priority must: Advance a Quarterly Objective, and Be schedulable on specific days.'",
        "5 numbered input fields (1-5)",
        "Each priority can optionally link to a quarterly goal (dropdown)",
        "Show linked goal as badge if selected",
        "Auto-save on blur",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Added Section 4 with Target icon and indigo color theme. 5 numbered priority inputs with native select dropdown for goal linking. Linked goals show as badges with Link2 icon. Priorities stored as newline-separated 'text|goalId' format. Auto-saves on blur and on goal change. TypeScript build passes."
    },
    {
      "id": "US-010",
      "title": "Create Section 5: Kill List",
      "description": "As a user, I want to explicitly list what I'm NOT doing this week.",
      "acceptanceCriteria": [
        "Add Section 5 card with header 'Kill List (Explicit Neglect)'",
        "Instruction text: 'List items you are intentionally deprioritizing this week to protect focus.'",
        "Multiline textarea for kill_list",
        "Auto-save on blur",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Added Section 5 card with Skull icon and slate color theme. Multiline textarea auto-saves on blur. TypeScript build passes."
    },
    {
      "id": "US-011",
      "title": "Create Section 6: Forward Setup",
      "description": "As a user, I want to prep for Monday before finishing the review.",
      "acceptanceCriteria": [
        "Add Section 6 card with header 'Forward Setup (5 minutes max)'",
        "Three checkboxes:",
        "  - Block workouts on calendar -> workouts_blocked",
        "  - Pre-decide top 3 priorities for Monday -> monday_top_3_decided",
        "  - Prep first Daily Focus Card for Monday -> monday_focus_card_prepped",
        "Auto-save on check",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Added Section 6 card with FastForward icon and emerald color theme (border-emerald-200, bg-emerald-50/50). Three checkboxes with auto-save on change via handleForwardSetupChange callback. TypeScript build passes."
    },
    {
      "id": "US-012",
      "title": "Add weekly review completion logic",
      "description": "As a user, the review should be marked complete when all sections are filled.",
      "acceptanceCriteria": [
        "Review is 'completed' when:",
        "  - source_review_completed is true",
        "  - wins_shipped has content",
        "  - losses_friction has content",
        "  - All metrics have values",
        "  - All system health checks answered",
        "  - At least 1 weekly priority set",
        "  - All forward setup checkboxes checked",
        "Show completion status at top of page",
        "Show 'Mark as Complete' button when criteria met",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Added checkCompletionCriteria function that validates 7 criteria: source review, wins/losses content, metrics filled, health checks answered, priorities set, and forward setup complete. Completion status card shows progress bar, checklist with checkmarks, and Mark as Complete button when all criteria met. TypeScript build passes."
    },
    {
      "id": "US-013",
      "title": "Auto-populate metrics from daily plans",
      "description": "As a user, I want the system to pre-fill metrics by tallying my daily habit completions.",
      "acceptanceCriteria": [
        "When weekly review loads, calculate from daily_plans:",
        "  - Count 'Workout' habit completions across 7 days",
        "  - Count 'Walk' habit completions across 7 days",
        "  - Count 'Writing' habit completions across 7 days",
        "  - Count 'House Reset' habit completions across 7 days",
        "Pre-populate the 'completed' fields with these counts",
        "User can still manually override the values",
        "Add 'Refresh from Daily Plans' button to recalculate",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Added habit_tally method to WeeklyReview model that counts habit completions by name. Includes intelligent matching for workout/walk/writing/house reset patterns. Frontend auto-populates null metric fields on load and provides 'Refresh from Daily Plans' button in Section 2. TypeScript build passes."
    },
    {
      "id": "US-014",
      "title": "Create Mention model and migration",
      "description": "As a developer, I need to store mentions of family members in text content.",
      "acceptanceCriteria": [
        "Create mentions table with: mentionable_type (string), mentionable_id (integer), user_id (references), mentioned_user_id (references), text_field (string), created_at",
        "Add polymorphic association (mentionable belongs to Goal, DailyPlan, TopPriority, WeeklyReview, or other Review models)",
        "Create Mention model with: belongs_to :user, belongs_to :mentioned_user (class_name: 'User'), belongs_to :mentionable (polymorphic)",
        "Add has_many :mentions, as: :mentionable to Goal, DailyPlan, TopPriority, WeeklyReview, MonthlyReview, QuarterlyReview, AnnualReview models",
        "Add has_many :mentions, foreign_key: :mentioned_user_id to User model",
        "Add index on [mentionable_type, mentionable_id]",
        "Add index on mentioned_user_id",
        "Run migration successfully",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Created Mention model with polymorphic mentionable association. Added has_many :mentions to Goal, DailyPlan, TopPriority, WeeklyReview, MonthlyReview, QuarterlyReview, AnnualReview. Added has_many :mentions (received) and :mentions_created to User. Includes unique index to prevent duplicate mentions. Migration and all associations verified working."
    },
    {
      "id": "US-015",
      "title": "Create MentionParserService to extract @mentions from text",
      "description": "As a developer, I need a service to parse text and extract @firstname mentions.",
      "acceptanceCriteria": [
        "Create MentionParserService in backend/app/services/",
        "Service method extract_mentions(text, family_id) returns array of user objects",
        "Regex pattern matches @firstname (case-insensitive, word boundary)",
        "Looks up users by first name within the specified family (case-insensitive match)",
        "Returns empty array if no matches found",
        "Write RSpec unit tests for the service",
        "Test edge cases: multiple mentions, duplicate mentions, non-existent names",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Created MentionParserService with extract_mentions(text, family_id) method. Uses regex /@(\\w+)/i to match mentions, looks up family members by first name (case-insensitive). Returns unique User objects. Comprehensive RSpec tests (21 examples) cover single/multiple mentions, case-insensitivity, duplicates, edge cases, and invalid inputs. All tests pass, rubocop clean."
    },
    {
      "id": "US-016",
      "title": "Add concern for mention processing",
      "description": "As a developer, I want DRY code for processing mentions across multiple models.",
      "acceptanceCriteria": [
        "Create Mentionable concern in backend/app/models/concerns/mentionable.rb",
        "Concern adds has_many :mentions, as: :mentionable",
        "Concern adds after_save :process_mentions callback",
        "Concern adds class method mentionable_fields to define which fields to scan",
        "process_mentions method scans all defined fields for @mentions",
        "Creates Mention records for new mentions",
        "Deletes Mention records for removed mentions",
        "Only processes if relevant fields changed",
        "Write RSpec tests for the concern",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Created Mentionable concern with mentionable_fields class method, after_save :process_mentions callback, and smart family/user detection via mentionable_family_id and mentionable_user helper methods. Supports models with direct family/user, creator, or daily_plan associations. 24 comprehensive RSpec tests covering creation, update, deletion of mentions, case-insensitivity, multiple fields, and edge cases. All tests pass, rubocop clean."
    },
    {
      "id": "US-017",
      "title": "Include Mentionable in all relevant models",
      "description": "As a user, when I save content with @mentions, the system should create Mention records.",
      "acceptanceCriteria": [
        "Include Mentionable concern in Goal model, define fields: [:title, :description, :notes]",
        "Include Mentionable concern in TopPriority model, define fields: [:title]",
        "Include Mentionable concern in DailyPlan model, define fields: [:shutdown_shipped, :shutdown_blocked]",
        "Include Mentionable concern in WeeklyReview model, define fields: [:wins_shipped, :losses_friction, :metrics_notes, :system_to_adjust, :weekly_priorities, :kill_list]",
        "Include Mentionable concern in MonthlyReview, QuarterlyReview, AnnualReview models with appropriate fields",
        "Write RSpec model tests for each",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Included Mentionable concern in Goal (:title, :description), TopPriority (:title), DailyPlan (:shutdown_shipped, :shutdown_blocked), WeeklyReview (6 fields), MonthlyReview (:lessons_learned), QuarterlyReview (:insights), AnnualReview (:lessons_learned, :next_year_theme). Created new specs for MonthlyReview, QuarterlyReview, AnnualReview. Added Mentionable describe blocks to existing specs. All 44 Mentionable tests pass."
    },
    {
      "id": "US-018",
      "title": "Send notifications when users are mentioned",
      "description": "As a user, when someone mentions me, I should receive a notification.",
      "acceptanceCriteria": [
        "Add after_create callback to Mention model to send notification",
        "Uses NotificationService.create_and_broadcast",
        "Notification title: '{Mentioner Name} mentioned you'",
        "Notification body includes context (e.g., 'in their weekly review' or 'in goal: {title}')",
        "Notification links to the mentionable record",
        "Add :mention to notification_type enum in Notification model if needed",
        "Write RSpec tests for notification delivery",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Added :mention to notification_type enum. Created notify_mention method in NotificationService with context-aware body/links for all 7 mentionable types. Added after_create callback to Mention model that skips self-mentions. 16 new RSpec tests covering all mentionable types and edge cases. 71 total mention-related tests pass."
    },
    {
      "id": "US-019",
      "title": "Add mentioned_by filter to all content APIs",
      "description": "As a user, I want to filter content where I was mentioned.",
      "acceptanceCriteria": [
        "Add mentioned_by query param to Goals, DailyPlans, WeeklyReviews, MonthlyReviews, QuarterlyReviews, AnnualReviews endpoints",
        "Add scope :mentioned_by to each model",
        "Scope joins mentions table and filters by mentioned_user_id",
        "Write request specs for each endpoint",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": true,
      "notes": "Added mentioned_by scope to Goal, DailyPlan, WeeklyReview, MonthlyReview, QuarterlyReview, AnnualReview models. Updated all corresponding index actions in controllers to support mentioned_by query param. Added new index action to DailyPlans controller with route. Added DailyPlanPolicy#index? for authorization. 12 new request specs cover all mentioned_by filters. All tests pass."
    },
    {
      "id": "US-020",
      "title": "Update frontend types for mentions",
      "description": "As a developer, I need TypeScript types for mentions.",
      "acceptanceCriteria": [
        "Add Mention type to frontend/src/lib/api.ts",
        "Add mentions array to Goal, DailyPlan, WeeklyReview, and other Review types",
        "Add mentionedBy optional param to all content hooks",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Create MentionInput component with autocomplete",
      "description": "As a user, when I type @ in a text field, I want to see an autocomplete list of family members.",
      "acceptanceCriteria": [
        "Create MentionInput component in frontend/src/components/ui/",
        "Component wraps Input or Textarea based on multiline prop",
        "Detects @ character and shows dropdown of family members",
        "Filters family members as user continues typing after @",
        "Inserts @firstname when user selects from dropdown",
        "Highlights @mentions in the text with blue/primary color",
        "Uses Popover component for dropdown positioning",
        "Keyboard navigation: arrow keys to select, Enter to insert, Esc to close",
        "Accepts all standard input/textarea props",
        "Export useFamilyMembers hook to fetch family members",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Replace textareas with MentionInput across app",
      "description": "As a user, I want @mention autocomplete in all text fields.",
      "acceptanceCriteria": [
        "Replace textareas in Goals form (title, description, notes)",
        "Replace textareas in DailyPlanner (top priorities, shutdown notes)",
        "Replace textareas in new WeeklyReview form (all text fields)",
        "Replace textareas in other Review forms",
        "Display existing mentions as highlighted text",
        "Typecheck passes",
        "Verify in browser for each form using dev-browser skill"
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Add mention filters to all content pages",
      "description": "As a user, I want to filter content where I was mentioned.",
      "acceptanceCriteria": [
        "Add 'Mentioned Me' filter toggle to Goals page",
        "Add 'Mentioned Me' filter toggle to Reviews pages (all types)",
        "When enabled, pass mentionedBy param to respective hooks",
        "Show active filter state in UI",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Add recent mentions endpoint and UI indicator",
      "description": "As a user, I want to see when I have recent mentions.",
      "acceptanceCriteria": [
        "Add GET /api/v1/families/:family_id/mentions/recent endpoint",
        "Endpoint returns mentions of current user from last 7 days",
        "Include mentionable details (type, id, title/summary)",
        "Create useMentions hook in frontend",
        "Display recent mention count in navigation or header (if > 0)",
        "Click indicator navigates to mentions view or shows dropdown",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    }
  ]
}
