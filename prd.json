{
  "project": "Entmoot",
  "branchName": "ralph/production-auth-fixes",
  "description": "Fix production authentication failures after JWT-to-session migration",
  "userStories": [
    {
      "id": "US-001",
      "title": "Fix session cookie domain configuration",
      "description": "As a user, I need my login session to work across subdomains so API requests are authenticated.",
      "acceptanceCriteria": [
        "Add domain: :all to session cookie configuration in backend/config/application.rb",
        "Change same_site: :lax to same_site: :none for cross-origin cookie sending",
        "Keep secure: Rails.env.production? setting",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Added session middleware to config/application.rb"
    },
    {
      "id": "US-002",
      "title": "Update ActionCable connection for session auth",
      "description": "As a developer, I need ActionCable to authenticate via session cookies instead of JWT tokens.",
      "acceptanceCriteria": [
        "Remove JWT token decoding from backend/app/channels/application_cable/connection.rb",
        "Use request.session and env['warden'] to get authenticated user",
        "Handle case where no session exists by rejecting connection",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Simplified to use env['warden'] directly - cleaner than request.session approach"
    },
    {
      "id": "US-003",
      "title": "Add CORS expose headers for cookies",
      "description": "As a developer, I need CORS to properly expose Set-Cookie headers for session management.",
      "acceptanceCriteria": [
        "Add expose: ['Set-Cookie'] to CORS configuration in backend/config/initializers/cors.rb",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Added expose: %w[Set-Cookie] to CORS config"
    },
    {
      "id": "US-004",
      "title": "Add request spec for cross-origin session auth",
      "description": "As a developer, I need regression tests to verify session auth works correctly.",
      "acceptanceCriteria": [
        "Add spec testing that session cookie is set on login in backend/spec/requests/api/v1/auth/sessions_spec.rb",
        "Add spec testing that session cookie authenticates subsequent requests",
        "Add spec testing logout clears session",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Added 5 specs: session cookie on login, session auth with JWT, session persistence, logout clears session. Also added warden.set_user on login and warden.logout on logout."
    },
    {
      "id": "US-005",
      "title": "Add ActionCable connection spec for session auth",
      "description": "As a developer, I need tests verifying ActionCable authenticates via sessions.",
      "acceptanceCriteria": [
        "Create backend/spec/channels/connection_spec.rb",
        "Add spec testing connection with valid session succeeds",
        "Add spec testing connection without session is rejected",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Created spec/channels/application_cable/connection_spec.rb with 3 tests: valid session connects, no session rejected, nil warden user rejected. All 1626 tests pass."
    },
    {
      "id": "US-006",
      "title": "Update frontend WebSocket to handle reconnection",
      "description": "As a user, I need WebSocket to gracefully handle authentication state changes.",
      "acceptanceCriteria": [
        "WebSocket reconnects when auth state changes in frontend/src/hooks/useNotificationWebSocket.ts",
        "WebSocket disconnects cleanly on logout",
        "No stale connection attempts after logout",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Changed from token-based to session-based auth. Added connection ID tracking to prevent stale reconnections. Verified login/logout/re-login flow in browser."
    }
  ]
}
