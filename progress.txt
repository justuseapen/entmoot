# Ralph Progress Log
Started: Tue Jan 20 16:20:13 EST 2026

## Codebase Patterns
- SelectTrigger components need explicit width/height when used as icon-only buttons - default styles assume text content
- Use `w-11` (44px) minimum for touch targets on mobile to meet iOS accessibility guidelines
- Use `aria-label` for icon-only interactive elements
- Migrations are excluded from rubocop via `.rubocop.yml` - no need to worry about method length for migrations
- When adding nullable boolean fields intentionally (e.g., for "unanswered" state), rubocop will warn but can be ignored in migrations
- Polymorphic associations: use `belongs_to :X, polymorphic: true` and `has_many :Y, as: :X, dependent: :destroy`
- When using `t.references` with custom foreign key, Rails auto-creates index - don't duplicate with `add_index`
- ActiveSupport::Concern structure: `extend ActiveSupport::Concern`, `included do...end`, `class_methods do...end`
- Use `saved_change_to_attribute?(field)` in after_save callbacks to check if specific field changed

---

## 2026-01-20 - US-001: Fix goal link button clickability in Daily Planner
- What was implemented: Fixed SelectTrigger clickability by adjusting size and padding
- Files changed: frontend/src/pages/DailyPlanner.tsx
- **Learnings for future iterations:**
  - The shadcn SelectTrigger with `size="sm"` reduces height to h-8, which combined with narrow width can make buttons hard to click
  - When using Select components as icon-only buttons, remove size prop and explicitly set dimensions
  - w-10 (40px) with px-3 padding leaves only ~16px for content, not enough for two icons (Link2 + chevron)
  - Touch target minimum: 44x44px for iOS, achieved with `h-10 w-11`
---

## 2026-01-20 - US-002: Add new fields to WeeklyReview model for template sections
- What was implemented: Created migration to add 21 new fields to weekly_reviews table
- Files changed:
  - backend/db/migrate/20260120212323_add_template_fields_to_weekly_reviews.rb (new)
  - backend/db/schema.rb (auto-updated)
- **Learnings for future iterations:**
  - The weekly_reviews table now has both old jsonb columns (wins, challenges, next_week_priorities, lessons_learned) AND new text columns (wins_shipped, losses_friction, weekly_priorities, kill_list) - these coexist for backward compatibility
  - System health check booleans (daily_focus_used_every_day, weekly_priorities_clear, cleaning_system_held, training_volume_sustainable) are intentionally nullable - nil means "not answered yet"
  - Forward setup booleans (workouts_blocked, monday_top_3_decided, monday_focus_card_prepped) default to false with NOT NULL
  - walks_planned and house_resets_planned default to 7 (days in a week)
---

## 2026-01-20 - US-003: Update WeeklyReview API to support new fields
- What was implemented: Updated controller to permit and serialize all 21 new template fields
- Files changed:
  - backend/app/controllers/api/v1/weekly_reviews_controller.rb
  - backend/spec/requests/api/v1/weekly_reviews_spec.rb
- **Learnings for future iterations:**
  - Rails `permit()` requires array params (e.g., `wins: []`) to come AFTER scalar params, otherwise syntax error
  - Refactored controller into PERMITTED_SCALAR_PARAMS/PERMITTED_ARRAY_PARAMS constants and helper methods to stay under rubocop line limits
  - API response organized into helper methods: base_attributes, legacy_attributes, template_attributes (with sub-methods for each section)
  - Use `include()` matcher with hash args for concise multi-field assertions in specs
  - Use `:aggregate_failures` tag on specs with many expectations to satisfy RSpec/MultipleExpectations cop
---

## 2026-01-20 - US-004: Update frontend WeeklyReview type
- What was implemented: Updated TypeScript types for WeeklyReview and UpdateWeeklyReviewData to include all 21 new template fields
- Files changed:
  - frontend/src/lib/weeklyReviews.ts
- **Learnings for future iterations:**
  - WeeklyReview type fields match backend snake_case naming (API returns snake_case)
  - Use `| null` for nullable fields from database (e.g., `boolean | null` for system health check booleans that can be unanswered)
  - Forward setup booleans (workouts_blocked, monday_top_3_decided, monday_focus_card_prepped) are non-nullable since they have NOT NULL default false in DB
  - UpdateWeeklyReviewData uses optional properties (`?`) since not all fields need to be sent on every update
  - useWeeklyReview hook didn't need changes - it already properly uses the types from weeklyReviews.ts
---

## 2026-01-20 - US-005: Create new WeeklyReview UI - Section 0: Source Review
- What was implemented: Added Section 0 card with source review reminder and daily plan links
- Files changed:
  - backend/app/controllers/api/v1/weekly_reviews_controller.rb (added daily_plans to API response)
  - frontend/src/lib/weeklyReviews.ts (added DailyPlanSummary type)
  - frontend/src/pages/WeeklyReview.tsx (added Section 0 component)
- **Learnings for future iterations:**
  - The WeeklyReview model already has a `daily_plans` method that queries DailyPlan for the week's date range
  - When displaying calendar grids, use `grid-cols-2 sm:grid-cols-4 lg:grid-cols-7` for responsive 7-day layouts
  - Use `toISOString().split("T")[0]` to compare dates in YYYY-MM-DD format
  - The Checkbox component from shadcn accepts `onCheckedChange` (not `onChange`) and passes a `CheckedState` type
  - Section 0 uses amber color scheme (border-amber-200, bg-amber-50/50) to distinguish it from other sections
---

## 2026-01-20 - US-006: Create Section 1: Review (Evidence-based)
- What was implemented: Added Section 1 card with wins_shipped and losses_friction textareas with auto-save on blur
- Files changed:
  - frontend/src/pages/WeeklyReview.tsx
- **Learnings for future iterations:**
  - Section 1 follows the same pattern as Section 0 but without the amber styling (uses default card styling)
  - The ClipboardList icon from lucide-react is used for the section header
  - Auto-save pattern uses `onBlur` callback with `useCallback` that calls `updateReview.mutateAsync`
  - Textarea components accept standard `onChange` (not `onCheckedChange` like Checkbox)
  - State variables follow naming pattern: camelCase for React state (winsShipped), snake_case for API fields (wins_shipped)
---

## 2026-01-20 - US-007: Create Section 2: Metrics Snapshot
- What was implemented: Added Section 2 card with metrics input pairs, percentage display, meals prepped toggle, and notes textarea
- Files changed:
  - frontend/src/pages/WeeklyReview.tsx
- **Learnings for future iterations:**
  - Used inline MetricRow component for cleaner code - each row has completed/planned inputs and percentage display
  - parseNumberInput helper converts empty string to null for proper API handling
  - calcPercentage helper returns null if either completed or planned is null (so percentage is only shown when both values exist)
  - For Y/N toggles, use paired Buttons with conditional styling instead of Checkbox
  - Color-coded percentages: green ≥80%, yellow ≥50%, red <50%
  - The Activity icon from lucide-react fits the metrics/tracking theme
  - Type MetricsNumberField was defined inline using union type for type safety on blur handlers
---

## 2026-01-20 - US-008: Create Section 3: System Health Check
- What was implemented: Added Section 3 card with Y/N toggle buttons for 4 health check questions and conditional textarea
- Files changed:
  - frontend/src/pages/WeeklyReview.tsx
- **Learnings for future iterations:**
  - HeartPulse icon from lucide-react fits the health check theme well
  - Reused Y/N toggle pattern from Section 2 (meals_prepped_held) but created HealthCheckQuestion inline component for cleaner code
  - Conditional rendering with `hasAnyNo` check: textarea only appears when at least one answer is false (not null)
  - SystemHealthField type union ensures type safety for the 4 boolean fields
  - Auto-save happens immediately on button click (onChange), not on blur, since buttons don't have blur events
  - The system_to_adjust textarea uses onBlur for auto-save (same pattern as other textareas)
  - Rose color scheme (text-rose-600) for the section header to distinguish from other sections
---

## 2026-01-20 - US-009: Create Section 4: This Week's Priorities
- What was implemented: Added Section 4 card with 5 numbered priority inputs and optional quarterly goal linking
- Files changed:
  - frontend/src/pages/WeeklyReview.tsx
- **Learnings for future iterations:**
  - Priorities stored in `weekly_priorities` field as newline-separated "text|goalId" format (e.g., "Write blog post|42\nReview code")
  - Used native HTML select element (not shadcn Select) for goal dropdown - simpler and avoids SelectTrigger sizing issues
  - useGoals hook with `time_scale: "quarterly"` filter to fetch only quarterly goals
  - Goal type must be imported with `import type { Goal }` due to `verbatimModuleSyntax` in tsconfig
  - Target icon and indigo color theme for priorities section
  - PriorityRow inline component for cleaner code - each row has number badge, input, dropdown, and optional badge
  - Goal link changes save immediately (unlike text blur) since dropdown change is a discrete action
  - Link2 icon from lucide-react used for the linked goal badge
---

## 2026-01-20 - US-010: Create Section 5: Kill List
- What was implemented: Added Section 5 card for explicitly deprioritizing items (kill list)
- Files changed:
  - frontend/src/pages/WeeklyReview.tsx
- **Learnings for future iterations:**
  - Followed the same pattern as previous sections: state variable, useEffect initialization, blur handler, render function
  - Skull icon from lucide-react fits the "kill" theme well
  - Slate color scheme (border-slate-200, bg-slate-50/50, text-slate-600) provides neutral/gray appearance distinct from other sections
  - The kill_list field is a simple text field (not jsonb array), so no parsing needed like weekly_priorities
---

## 2026-01-20 - US-011: Create Section 6: Forward Setup
- What was implemented: Added Section 6 card with three checkboxes for forward planning
- Files changed:
  - frontend/src/pages/WeeklyReview.tsx
- **Learnings for future iterations:**
  - Followed established pattern: state variables, useEffect initialization, checkbox change handler, render function
  - FastForward icon from lucide-react fits the "forward setup" theme
  - Emerald color scheme (border-emerald-200, bg-emerald-50/50) provides fresh/forward-looking appearance
  - ForwardSetupField type union ensures type safety for the 3 boolean fields
  - Checkbox changes auto-save immediately via handleForwardSetupChange callback (same pattern as system health checks)
  - These fields default to false with NOT NULL in DB, so use ?? false in initialization (not || false since false is a valid value)
---

## 2026-01-20 - US-012: Add weekly review completion logic
- What was implemented: Added completion criteria checker and completion status UI to weekly review page
- Files changed:
  - frontend/src/pages/WeeklyReview.tsx
- **Learnings for future iterations:**
  - Created CompletionCriteria type to track all 7 criteria states plus overall completion status
  - checkCompletionCriteria function calculates criteria on every render (no memoization needed since state changes trigger re-renders anyway)
  - Completion status card placed between StandaloneTip and Section 0 to be visible at top
  - Three states: in-progress (blue card with checklist), ready-to-complete (green button enabled), completed (celebration card with PartyPopper icon)
  - Progress bar shows percentage via (completedCount / totalCount) * 100
  - Criteria checklist uses 2-column grid on sm+ breakpoints for compact display
  - Circle and CheckCircle icons from lucide-react used for unchecked/checked states
  - handleMarkAsComplete callback sets completed: true on the review, similar to handleComplete but without legacy field handling
---

## 2026-01-20 - US-013: Auto-populate metrics from daily plans
- What was implemented: Added habit_tally method to backend and auto-populate logic to frontend
- Files changed:
  - backend/app/models/weekly_review.rb (added habit_tally method)
  - backend/app/controllers/api/v1/weekly_reviews_controller.rb (include habit_tally in response)
  - frontend/src/lib/weeklyReviews.ts (added HabitTally type)
  - frontend/src/pages/WeeklyReview.tsx (added auto-populate and refresh button)
- **Learnings for future iterations:**
  - Habit names are user-defined, so use case-insensitive substring matching to map habits to metric categories
  - Pattern: "workout"/"exercise"/"gym"/"training" -> workouts_completed
  - Pattern: "walk"/"steps"/"cardio" -> walks_completed
  - Pattern: "writ"/"journal"/"blog" -> writing_sessions_completed
  - Pattern: "house"/"clean"/"tidy"/"reset" -> house_resets_completed
  - Use find_each instead of each when iterating over ActiveRecord collections (rubocop Rails/FindEach)
  - Auto-populate only when DB value is null (don't override user's manual input)
  - RefreshCw icon from lucide-react is good for refresh/recalculate buttons
  - HabitTally uses TypeScript index signature: `{ [habitName: string]: number }`
---

## 2026-01-20 - US-014: Create Mention model and migration
- What was implemented: Created mentions table and Mention model with polymorphic association, added has_many :mentions to all mentionable models
- Files changed:
  - backend/db/migrate/20260120170348_create_mentions.rb (new)
  - backend/app/models/mention.rb (new)
  - backend/app/models/user.rb (added mentions and mentions_created associations)
  - backend/app/models/goal.rb (added has_many :mentions)
  - backend/app/models/daily_plan.rb (added has_many :mentions)
  - backend/app/models/top_priority.rb (added has_many :mentions)
  - backend/app/models/weekly_review.rb (added has_many :mentions)
  - backend/app/models/monthly_review.rb (added has_many :mentions)
  - backend/app/models/quarterly_review.rb (added has_many :mentions)
  - backend/app/models/annual_review.rb (added has_many :mentions)
  - backend/db/schema.rb (auto-updated)
- **Learnings for future iterations:**
  - Polymorphic associations: `belongs_to :mentionable, polymorphic: true` and `has_many :mentions, as: :mentionable`
  - When using `t.references` with `foreign_key: { to_table: :users }`, Rails auto-creates an index on that column - don't add a duplicate index
  - User has two mention associations: `mentions_created` (where user_id is the author) and `mentions` (where mentioned_user_id is the recipient)
  - Rubocop complains about redundant `foreign_key: :user_id` when the foreign key name matches the association name - just omit it
  - Unique index on [mentionable_type, mentionable_id, user_id, mentioned_user_id, text_field] prevents duplicate mentions in the same field
  - Pre-existing test failures (Goal model) are due to calendar sync feature referencing missing `notes` column - unrelated to mentions work
---

## 2026-01-20 - US-015: Create MentionParserService to extract @mentions from text
- What was implemented: Created MentionParserService to parse text for @firstname mentions and return matching User objects
- Files changed:
  - backend/app/services/mention_parser_service.rb (new)
  - backend/spec/services/mention_parser_service_spec.rb (new)
- **Learnings for future iterations:**
  - Use `/@(\w+)/i` regex pattern to match @mentions - \w+ captures word characters (letters, numbers, underscore)
  - To match user first name: split full name and take first word, compare case-insensitively with downcased mention text
  - Family.members returns users through family_memberships association - use .select to filter in Ruby rather than complex SQL joins
  - RSpec `contain_exactly` matcher is ideal for testing arrays where order doesn't matter
  - Handle edge cases: nil/blank text, invalid family_id, non-existent usernames all return empty array
  - Service uses class << self pattern with class methods, matching other services in codebase
---

## 2026-01-20 - US-016: Add concern for mention processing
- What was implemented: Created Mentionable concern with DRY code for processing @mentions across multiple models
- Files changed:
  - backend/app/models/concerns/mentionable.rb (new)
  - backend/spec/models/concerns/mentionable_spec.rb (new)
- **Learnings for future iterations:**
  - ActiveSupport::Concern pattern: use `extend ActiveSupport::Concern`, `included do ... end`, and `class_methods do ... end`
  - Use `unless reflect_on_association(:mentions)` to avoid re-declaring association if model already has it
  - Use `saved_change_to_attribute?(field)` to check if a specific field changed after save (not `changed?` which is pre-save)
  - For rubocop, rename `get_X` accessor methods to just `X` or use verb form like `mentionable_text_fields`
  - Models access family differently: some have `belongs_to :family`, others get family via `daily_plan.family`
  - Models access user differently: some have `belongs_to :user`, Goal uses `belongs_to :creator`
  - Split complex methods into smaller helper methods to satisfy rubocop ABC size limits
  - Testing concerns: use `before(:all)` with `include(described_class)` and `mentionable_fields` to configure real models for testing
  - Use `rubocop:disable RSpec/BeforeAfterAll` inline comments to acknowledge intentional use of before(:all)/after(:all)
  - Pre-existing Goal model failures (saved_change_to_notes?) are from calendar sync feature - unrelated to this work
---
