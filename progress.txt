# Ralph Progress Log
Started: January 2026

## Codebase Patterns
- Backend code lives in `/backend` directory (Rails 7.2 API-mode)
- Frontend code lives in `/frontend` directory (React 18 + TypeScript + Vite)
- Use Ruby 3.4.4 for compatibility with latest gems
- Use Node.js 22.13.1 for frontend (required by Vite v7)
- Run backend commands from the `/backend` directory
- Run frontend commands from the `/frontend` directory with `PATH="$HOME/.asdf/shims:$PATH"`
- Docker Compose services: `docker-compose up -d` for PostgreSQL and Redis
- RSpec tests: `bundle exec rspec`
- Rubocop linting: `bundle exec rubocop` (auto-fix: `bundle exec rubocop -A`)
- ESLint: `npm run lint` (auto-fix: `npm run lint -- --fix`)
- Build frontend: `npm run build`
- Rubocop uses `plugins:` syntax instead of `require:` for extensions
- All Ruby files must have `# frozen_string_literal: true` at the top
- Use double quotes for strings consistently
- Frontend uses `@/` path alias for imports (e.g., `@/components/ui/button`)
- shadcn/ui components live in `src/components/ui/`
- Auth endpoints under `/api/v1/auth/` namespace
- Use `auth_headers(user)` helper in request specs for authenticated requests
- JWT tokens generated with `Warden::JWTAuth::UserEncoder.new.call(user, :user, nil).first`
- Prefer `:unprocessable_content` over `:unprocessable_entity` (Rack deprecation)
- Use `Time.zone.at()` instead of `Time.at()` for timezone awareness
- Use `freeze_time` (from ActiveSupport::Testing::TimeHelpers) for time-related specs
- Pundit policies go in `app/policies/` directory
- Role enum in models: use `enum :role, { key: value }, validate: true` syntax
- For custom validation messages, use I18n keys (e.g., `:user_already_member`) and add to `config/locales/en.yml`
- Factory Bot factories should set auto-generated attributes (like token, expires_at) to avoid nil issues in `build` calls

---

## 2026-01-10 - US-001
- Implemented Rails 7.2 API-mode project setup in /backend directory
- Files created/changed:
  - `/backend/` - Full Rails 7.2 API application
  - `/backend/docker-compose.yml` - PostgreSQL 16 and Redis 7 services
  - `/backend/app/controllers/health_controller.rb` - Health check endpoint
  - `/backend/spec/requests/health_spec.rb` - Health endpoint tests
  - `/backend/config/initializers/sidekiq.rb` - Sidekiq configuration
  - `/backend/.rubocop.yml` - Custom Rubocop configuration
- **Learnings for future iterations:**
  - Ruby 3.3.0 has compatibility issues with `connection_pool` gem - use Ruby 3.4.4 instead
  - Rubocop now uses `plugins:` instead of `require:` for loading extensions
  - Rails generates a nested .git directory - remove it for mono-repo structure
  - asdf uses `asdf set` command instead of `asdf local` in newer versions
  - Database names follow pattern: `entmoot_development`, `entmoot_test`
---

## 2026-01-10 - US-002
- Implemented React 18 frontend project setup in /frontend directory
- Files created/changed:
  - `/frontend/` - Full React 18 + TypeScript + Vite application
  - `/frontend/vite.config.ts` - Vite config with Tailwind, React, and proxy to Rails API
  - `/frontend/src/index.css` - Tailwind CSS v4 with shadcn/ui theme variables
  - `/frontend/src/App.tsx` - Main app with React Router and TanStack Query providers
  - `/frontend/src/lib/api.ts` - API fetch utility and QueryClient configuration
  - `/frontend/src/stores/auth.ts` - Zustand auth store with persistence
  - `/frontend/src/pages/Home.tsx` - Landing page with shadcn Button component
  - `/frontend/src/pages/NotFound.tsx` - 404 page
  - `/frontend/src/components/ui/button.tsx` - shadcn Button component
  - `/frontend/eslint.config.js` - ESLint with Prettier and React plugins
  - `/frontend/.prettierrc` - Prettier config with Tailwind plugin
- **Learnings for future iterations:**
  - Vite v7 requires Node.js 20.19+ or 22.12+ - nvm may override asdf, use `PATH="$HOME/.asdf/shims:$PATH"` prefix
  - shadcn/ui init requires `baseUrl` and `paths` in both tsconfig.json and tsconfig.app.json
  - Tailwind CSS v4 uses `@import "tailwindcss"` instead of `@tailwind` directives
  - shadcn/ui components export non-component items (like `buttonVariants`), add eslint-disable for `react-refresh/only-export-components`
  - Prettier tailwind plugin auto-sorts class names
---

## 2026-01-10 - US-003
- Implemented User Authentication - Backend with Devise and JWT
- Files created/changed:
  - `/backend/app/models/user.rb` - User model with devise + JWT authentication
  - `/backend/app/models/jwt_denylist.rb` - JWT denylist for token revocation
  - `/backend/app/models/refresh_token.rb` - Refresh token model with rotation
  - `/backend/config/initializers/devise.rb` - Devise configuration with JWT
  - `/backend/config/routes.rb` - Auth routes under /api/v1/auth namespace
  - `/backend/app/controllers/api/v1/auth/registrations_controller.rb` - Registration endpoint
  - `/backend/app/controllers/api/v1/auth/sessions_controller.rb` - Login/logout endpoints
  - `/backend/app/controllers/api/v1/auth/users_controller.rb` - Current user endpoint
  - `/backend/app/controllers/api/v1/auth/passwords_controller.rb` - Password reset endpoints
  - `/backend/app/controllers/api/v1/auth/tokens_controller.rb` - Refresh token endpoint
  - `/backend/app/controllers/api/v1/base_controller.rb` - Base controller with auth
  - `/backend/db/migrate/` - Migrations for users, jwt_denylist, refresh_tokens
  - `/backend/spec/factories/` - Factories for User and RefreshToken
  - `/backend/spec/models/` - Model specs for User and RefreshToken
  - `/backend/spec/requests/api/v1/auth/` - Request specs for all auth endpoints
  - `/backend/spec/support/auth_helpers.rb` - Helper for generating auth headers in tests
- **Learnings for future iterations:**
  - Don't inherit from Devise controllers (RegistrationsController, SessionsController) for API-mode - use standalone controllers with Devise internals
  - Use `User.find_for_database_authentication(email:)` and `user.valid_password?(password)` for manual login
  - Use `Warden::JWTAuth::UserEncoder.new.call(user, :user, nil).first` to generate JWT tokens
  - JWT denylist needs `jti` (JWT ID) and `exp` (expiration) fields for token revocation
  - Devise routes need `devise_for :users, skip: %i[sessions registrations]` but keep `:passwords` for reset email URL helper
  - Rubocop prefers `:unprocessable_content` over `:unprocessable_entity` (deprecation)
  - Time.at requires timezone: use `Time.zone.at()` instead of `Time.at()`
  - RefreshToken auto-generates token via `before_validation` callback, so presence validation doesn't work with shoulda-matchers
  - 72 tests pass covering all auth scenarios including token refresh, password reset, and revoked tokens
---

## 2026-01-10 - US-004
- Implemented User Authentication - Frontend with React Hook Form and Zod
- Files created/changed:
  - `/frontend/src/lib/auth.ts` - Auth API functions (login, register, logout, getCurrentUser, refreshToken)
  - `/frontend/src/stores/auth.ts` - Updated Zustand store with refreshToken and loading state
  - `/frontend/src/pages/Login.tsx` - Login page with form validation
  - `/frontend/src/pages/Register.tsx` - Registration page with password strength validation
  - `/frontend/src/pages/Dashboard.tsx` - Protected dashboard showing user info
  - `/frontend/src/components/ProtectedRoute.tsx` - Auth guard component
  - `/frontend/src/components/ui/input.tsx` - shadcn Input component
  - `/frontend/src/components/ui/label.tsx` - shadcn Label component
  - `/frontend/src/components/ui/card.tsx` - shadcn Card component
  - `/frontend/src/App.tsx` - Updated routes with auth-aware redirects
  - `/frontend/src/pages/Home.tsx` - Updated with auth-aware navigation
  - `/frontend/package.json` - Added react-hook-form, @hookform/resolvers, zod
- **Learnings for future iterations:**
  - Use React Hook Form with Zod resolver for declarative form validation
  - Zustand persist middleware stores state in localStorage under configured key name
  - When logout function checks for token before API call, make sure to not early-return if token is null - still clear local state and navigate
  - shadcn/ui components installed via `npx shadcn@latest add <component>` may need prettier auto-fix
  - AuthenticatedRedirect wrapper prevents logged-in users from accessing login/register pages
  - ProtectedRoute wrapper redirects unauthenticated users to login with return URL in state
  - Vite proxy to Rails API is configured in vite.config.ts under server.proxy
  - Rails server must be running on port 3000 for Vite proxy to work (default proxy target)
---

## 2026-01-10 - US-005
- Implemented Family Model and Management - Backend
- Files created/changed:
  - `/backend/app/models/family.rb` - Family model with name, timezone, settings (jsonb)
  - `/backend/app/models/family_membership.rb` - FamilyMembership join model with role enum (admin, adult, teen, child, observer)
  - `/backend/app/models/invitation.rb` - Invitation model with token, email, role, expires_at for member invites
  - `/backend/app/models/user.rb` - Updated with family associations and role helpers
  - `/backend/app/controllers/api/v1/families_controller.rb` - Family CRUD endpoints
  - `/backend/app/controllers/api/v1/invitations_controller.rb` - Invitation management endpoints
  - `/backend/app/controllers/api/v1/memberships_controller.rb` - Membership management endpoints
  - `/backend/app/controllers/api/v1/base_controller.rb` - Added Pundit authorization
  - `/backend/app/policies/` - Pundit policies for Family, FamilyMembership, Invitation
  - `/backend/db/migrate/` - Migrations for families, family_memberships, invitations tables
  - `/backend/config/routes.rb` - Added family, invitation, and membership routes
  - `/backend/config/locales/en.yml` - Custom validation message for duplicate membership
  - `/backend/spec/` - Factories, model specs, and request specs (91 new tests)
  - `/backend/spec/rails_helper.rb` - Added ActiveSupport::Testing::TimeHelpers
- **Learnings for future iterations:**
  - Pundit policies need `include Pundit::Authorization` in base controller and `rescue_from Pundit::NotAuthorizedError`
  - For join model scopes that reference same table twice, use raw SQL with aliased table names
  - `accept!` method on Invitation returns boolean for success/failure, uses transaction for atomicity
  - Factory Bot factories should provide values for auto-generated fields to avoid nil comparisons in tests
  - Use `have_attributes` matcher for multiple attribute checks on single object
  - RSpec/LetSetup cop prefers inline `create` in tests over unused `let!` declarations
  - For conditional SQL in Pundit scopes, use string interpolation with `<<~SQL.squish` heredoc
  - 163 total tests pass covering all family management scenarios
---

## 2026-01-10 - US-007
- Implemented Pet Profiles - Backend
- Files created/changed:
  - `/backend/app/models/pet.rb` - Pet model with name, pet_type, avatar_url, birthday, notes
  - `/backend/app/models/family.rb` - Added has_many :pets association
  - `/backend/app/models/family_membership.rb` - Added can_manage_pets? helper method
  - `/backend/app/controllers/api/v1/pets_controller.rb` - Full CRUD endpoints for pets
  - `/backend/app/policies/pet_policy.rb` - Pundit policy restricting to admin/adult roles
  - `/backend/db/migrate/20260110205446_create_pets.rb` - Migration with unique index on family_id + name
  - `/backend/config/routes.rb` - Added pets resource nested under families
  - `/backend/config/locales/en.yml` - Added custom validation message for duplicate pet names
  - `/backend/spec/factories/pets.rb` - Pet factory with dog/cat traits
  - `/backend/spec/models/pet_spec.rb` - Model specs for validations and associations
  - `/backend/spec/models/family_spec.rb` - Added pets association test
  - `/backend/spec/requests/api/v1/pets_spec.rb` - Full request specs (40 new tests)
- **Learnings for future iterations:**
  - For nested resource policies, use `authorize @family, policy_class: PetPolicy` for index action
  - Add unique index on composite keys (family_id, name) to enforce uniqueness at DB level
  - Use I18n key `:taken_in_family` for custom uniqueness validation message
  - RSpec's `pluck("id")` is preferred over `map { |p| p["id"] }` for extracting values
  - Split specs with too many expectations (RSpec/MultipleExpectations cop) into separate tests
  - 203 total tests pass (40 new pet-related tests)
---

## 2026-01-10 - US-008
- Implemented Pet Profiles - Frontend
- Files created/changed:
  - `/frontend/src/components/PetCard.tsx` - Pet card displaying avatar/emoji, name, type, birthday/age, notes
  - `/frontend/src/components/PetModal.tsx` - Add/edit pet modal with form validation (name, type, photo URL, birthday, notes)
  - `/frontend/src/components/PetsList.tsx` - Pet grid with add/edit/delete functionality and delete confirmation dialog
  - `/frontend/src/hooks/usePets.ts` - TanStack Query hooks for CRUD operations with query key management
  - `/frontend/src/lib/pets.ts` - API functions for pet endpoints and pet type emoji mapping
  - `/frontend/src/pages/FamilySettings.tsx` - Added PetsList component to family hub
- **Learnings for future iterations:**
  - Pet emoji fallbacks use normalized lowercase with underscores (e.g., "guinea pig" -> "guinea_pig")
  - Age calculation handles both years and months for young pets (< 1 year shows months)
  - Role-based access: canManagePets checks for "admin" or "adult" roles
  - TanStack Query key pattern: `["pets", "list", familyId]` for list, `["pets", "detail", familyId, petId]` for single
  - Form reset in modals: use useEffect with [open, pet, reset] dependencies to reset on open/close/pet change
  - Select component needs controlled value and onValueChange to work with react-hook-form
---

## 2026-01-10 - US-009
- Implemented SMART Goals Model - Backend
- Files created/changed:
  - `/backend/app/models/goal.rb` - Goal model with SMART fields, time_scale/status/visibility enums, parent-child hierarchy
  - `/backend/app/models/goal_assignment.rb` - GoalAssignment join model for multi-member assignment
  - `/backend/app/controllers/api/v1/goals_controller.rb` - Full CRUD endpoints with filtering
  - `/backend/app/policies/goal_policy.rb` - Pundit policy with visibility rules (personal/shared/family)
  - `/backend/db/migrate/20260110213749_create_goals.rb` - Goals table migration
  - `/backend/db/migrate/20260110213814_create_goal_assignments.rb` - GoalAssignments table migration
  - `/backend/config/routes.rb` - Added goals resource nested under families
  - `/backend/config/locales/en.yml` - Added validation messages for goal_assignment
  - `/backend/app/models/user.rb` - Added created_goals, goal_assignments, assigned_goals associations
  - `/backend/app/models/family.rb` - Added goals association
  - `/backend/spec/factories/goals.rb` - Goal factory with traits for all enums and SMART fields
  - `/backend/spec/factories/goal_assignments.rb` - GoalAssignment factory
  - `/backend/spec/models/goal_spec.rb` - Model specs (44 tests)
  - `/backend/spec/models/goal_assignment_spec.rb` - Model specs (6 tests)
  - `/backend/spec/requests/api/v1/goals_spec.rb` - Request specs (52 tests)
- **Learnings for future iterations:**
  - For Pundit policy scope with complex visibility rules, use raw SQL with heredoc format (<<~SQL.squish)
  - Goal visibility: personal=creator only, shared=creator+assigned users, family=all family members
  - Scope lambdas should be multi-line for readability when they have conditionals
  - Split large controller response methods into smaller helper methods to satisfy ABC complexity metrics
  - Use `params.dig(:goal, :assignee_ids)` instead of `params[:goal][:assignee_ids]` for safer nil handling
  - TanStack Query key pattern for goals: `["goals", "list", familyId]`, `["goals", "detail", familyId, goalId]`
  - 102 new goal-related tests added, 305 total tests pass
---

## 2026-01-10 - US-010
- Implemented SMART Goals - Frontend
- Files created/changed:
  - `/frontend/src/pages/Goals.tsx` - Goal browser page with filtering by time scale, status, assignee
  - `/frontend/src/components/GoalCard.tsx` - Goal card displaying title, description, time scale badge, status badge, progress bar, assignees, edit/delete buttons
  - `/frontend/src/components/GoalModal.tsx` - Create/edit goal modal with Quick Form and SMART Wizard modes
  - `/frontend/src/components/GoalDetailView.tsx` - Goal detail dialog showing all fields, progress slider, status dropdown
  - `/frontend/src/hooks/useGoals.ts` - TanStack Query hooks for goal CRUD operations
  - `/frontend/src/lib/goals.ts` - API functions, type definitions, and helper utilities
  - `/frontend/src/components/ui/progress.tsx` - shadcn Progress component
  - `/frontend/src/components/ui/slider.tsx` - shadcn Slider component
  - `/frontend/src/components/ui/tabs.tsx` - shadcn Tabs component
  - `/frontend/src/components/ui/textarea.tsx` - shadcn Textarea component
  - `/frontend/src/App.tsx` - Added /families/:id/goals route
  - `/frontend/src/pages/FamilySettings.tsx` - Added link to Goals page
- **Learnings for future iterations:**
  - Goal modal supports two modes: Quick Form (single form with tabs) and SMART Wizard (step-by-step)
  - Wizard has 7 steps: Basic Info, Specific, Measurable, Achievable, Relevant, Time-Bound, Settings
  - Parent goal selector filters out daily goals and the current goal being edited
  - canManageGoals checks for admin/adult/teen roles
  - Goal cards check if current user is the creator for edit/delete permissions
  - GoalDetailView fetches goal details separately to get SMART fields (not included in list response)
  - Progress update in detail view uses local state with cancel/save buttons
  - Status change in detail view updates immediately on select change
---

## 2026-01-10 - US-011
- Implemented Goal Hierarchy Visualization
- Files created/changed:
  - `/frontend/src/pages/GoalTree.tsx` - Goal tree page with member filtering, time scale legend, empty state guidance
  - `/frontend/src/components/GoalTreeNode.tsx` - Recursive tree node component with expand/collapse, visual connectors
  - `/frontend/src/pages/Goals.tsx` - Added "Tree View" link button in header
  - `/frontend/src/App.tsx` - Added /families/:id/goals/tree route
- **Learnings for future iterations:**
  - Tree visualization can be built with pure CSS connectors (no library needed)
  - Use recursive component pattern for tree nodes with level prop for indentation
  - Color-code by time scale using consistent color mapping (red=annual, yellow=quarterly, green=monthly, blue=weekly, purple=daily)
  - Auto-expand first 2 levels (level < 2) for good UX on initial load
  - TIME_SCALE_ORDER array useful for sorting goals from annual down to daily
  - Filter by member should check both creator.id and assignees for goal ownership
  - hasLinkedGoals check (any goal.parent_id !== null) determines whether to show empty state guidance
  - GoalDetailView can be reused from Goals page for clicking tree nodes
---

## 2026-01-11 - US-012
- Implemented Daily Planning - Backend
- Files created/changed:
  - `/backend/app/models/daily_plan.rb` - DailyPlan model with date, user, family, intention fields
  - `/backend/app/models/daily_task.rb` - DailyTask model with title, completed, position, optional goal link
  - `/backend/app/models/top_priority.rb` - TopPriority model (max 3) with priority_order validation
  - `/backend/app/controllers/api/v1/daily_plans_controller.rb` - today/show/update endpoints
  - `/backend/app/policies/daily_plan_policy.rb` - Pundit policy for daily plan authorization
  - `/backend/db/migrate/20260111005438_create_daily_plans.rb` - DailyPlans table
  - `/backend/db/migrate/20260111005453_create_daily_tasks.rb` - DailyTasks table
  - `/backend/db/migrate/20260111005508_create_top_priorities.rb` - TopPriorities table
  - `/backend/config/routes.rb` - Added daily_plans routes under families
  - `/backend/config/locales/en.yml` - Added validation messages for daily planning
  - `/backend/app/models/user.rb` - Added daily_plans association
  - `/backend/app/models/family.rb` - Added daily_plans association
  - `/backend/spec/factories/daily_plans.rb` - DailyPlan factory with traits
  - `/backend/spec/factories/daily_tasks.rb` - DailyTask factory with traits
  - `/backend/spec/factories/top_priorities.rb` - TopPriority factory with traits
  - `/backend/spec/models/daily_plan_spec.rb` - Model specs (21 tests)
  - `/backend/spec/models/daily_task_spec.rb` - Model specs (14 tests)
  - `/backend/spec/models/top_priority_spec.rb` - Model specs (9 tests)
  - `/backend/spec/requests/api/v1/daily_plans_spec.rb` - Request specs (26 tests)
- **Learnings for future iterations:**
  - DailyPlan.find_or_create_for_today uses family's timezone to determine "today"
  - Use `Time.find_zone(family.timezone)&.today` for timezone-aware date calculation
  - TopPriority has max of 3 per day, enforced by priority_order range (1..3) and custom validation
  - DailyTask has auto-position via before_validation callback - don't validate presence of position
  - accepts_nested_attributes_for enables updating tasks/priorities in single PATCH request
  - Split controller response methods to satisfy ABC complexity metrics (plan_attributes + plan_associations)
  - For shoulda-matchers on auto-generated fields, use explicit subject with build(:factory) to avoid false positives
  - 371 total tests pass (66 new daily planning tests)
---
