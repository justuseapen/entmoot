# Ralph Progress Log
Started: Wed Jan 14 17:28:39 EST 2026

## Codebase Patterns
- ErrorResponse concern: Use `render_error(message, status:, errors:, suggestion:)` for structured API errors
- ApplicationController: Base controller for all API controllers, includes global rescue handlers + ErrorResponse concern
- Api::V1::BaseController: Authenticated routes inherit from here, includes Pundit + UserActivity; inherits `render_error` from concern
- When adding methods to concerns, ensure child controllers don't have conflicting method definitions
- Error detection: Use `errors.where(:field, :error_type).any?` to check for specific validation errors (not `errors.added?`)
- Auth controllers are at `app/controllers/api/v1/auth/` (registrations, sessions, passwords)
---

## 2026-01-14 - US-001
- Implemented ErrorResponse concern at `app/controllers/concerns/error_response.rb`
- Added three main methods:
  - `render_error(message, status:, errors:, suggestion:)` - Generic error responses
  - `render_validation_errors(record, suggestion:)` - For ActiveRecord validation errors
  - `render_not_found(resource_name, suggestion:)` - Friendly 404 messages
- Response format: `{ error: string, errors?: string[], suggestion?: string }`
- Files changed: `backend/app/controllers/concerns/error_response.rb` (new)
- **Learnings for future iterations:**
  - BaseController already has `render_error` and `render_errors` methods; the concern provides enhanced versions
  - Controller hierarchy: ApplicationController → Api::V1::BaseController → specific controllers
  - Concerns go in `app/controllers/concerns/` directory
---

## 2026-01-14 - US-002
- Updated ApplicationController to include ErrorResponse concern
- Modified handle_not_found to use render_not_found with friendly message and suggestion
- Modified handle_unexpected_error to use render_error with helpful suggestion
- Removed conflicting render_error method from Api::V1::BaseController (now inherited from concern)
- Updated render_forbidden in BaseController to use structured error response
- Files changed:
  - `backend/app/controllers/application_controller.rb`
  - `backend/app/controllers/api/v1/base_controller.rb`
- **Learnings for future iterations:**
  - BaseController had its own `render_error` method that conflicted with the concern's method signature
  - When adding keyword arguments to inherited methods, must update or remove overriding methods in child classes
  - ActiveRecord::RecordNotFound exception carries the model name via `exception.model`
  - All 1618 tests pass after changes
---

## 2026-01-14 - US-003
- Updated registrations controller to use ErrorResponse concern with friendly messages
- Added FRIENDLY_ERROR_MESSAGES constant mapping error types to user-friendly messages
- Implemented detect_error_type method using errors.where() for reliable detection
- Files changed:
  - `backend/app/controllers/api/v1/auth/registrations_controller.rb`
  - `backend/spec/requests/api/v1/auth/registrations_spec.rb`
- **Learnings for future iterations:**
  - Use `errors.where(:field, :type).any?` instead of `errors.added?(:field, :type)` - added? only works during validation, where() checks existing errors
  - Constants must be declared before the `private` keyword or Rubocop will flag "UselessConstantScoping"
  - Devise uses `:validatable` which adds email uniqueness and password length (6 chars minimum) validations
  - All 1618 tests pass after changes
---

## 2026-01-14 - US-004
- Updated sessions controller to use ErrorResponse concern with friendly messages
- Differentiated between "user not found" and "wrong password" scenarios:
  - User not found: "No account found with this email." with suggestion "Would you like to create one?"
  - Wrong password: "Incorrect email or password. Please try again." (no suggestion)
- Files changed:
  - `backend/app/controllers/api/v1/auth/sessions_controller.rb`
  - `backend/spec/requests/api/v1/auth/sessions_spec.rb`
- **Learnings for future iterations:**
  - `User.find_for_database_authentication(email:)` returns nil if user not found (does not raise)
  - For auth flows, distinguish between "not found" and "wrong credentials" to provide actionable suggestions
  - All 1618 tests pass after changes
---
