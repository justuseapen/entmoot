# Ralph Progress Log
Started: January 2026

## Codebase Patterns
- Backend code lives in `/backend` directory (Rails 7.2 API-mode)
- Frontend code lives in `/frontend` directory (React 18 + TypeScript + Vite)
- Use Ruby 3.4.4 for compatibility with latest gems
- Use Node.js 22.13.1 for frontend (required by Vite v7)
- Run backend commands from the `/backend` directory
- Run frontend commands from the `/frontend` directory with `PATH="$HOME/.asdf/shims:$PATH"`
- Docker Compose services: `docker-compose up -d` for PostgreSQL and Redis
- RSpec tests: `bundle exec rspec`
- Rubocop linting: `bundle exec rubocop` (auto-fix: `bundle exec rubocop -A`)
- ESLint: `npm run lint` (auto-fix: `npm run lint -- --fix`)
- Build frontend: `npm run build`
- Rubocop uses `plugins:` syntax instead of `require:` for extensions
- All Ruby files must have `# frozen_string_literal: true` at the top
- Use double quotes for strings consistently
- Frontend uses `@/` path alias for imports (e.g., `@/components/ui/button`)
- shadcn/ui components live in `src/components/ui/`
- Auth endpoints under `/api/v1/auth/` namespace
- Use `auth_headers(user)` helper in request specs for authenticated requests
- JWT tokens generated with `Warden::JWTAuth::UserEncoder.new.call(user, :user, nil).first`
- Prefer `:unprocessable_content` over `:unprocessable_entity` (Rack deprecation)
- Use `Time.zone.at()` instead of `Time.at()` for timezone awareness
- Use `freeze_time` (from ActiveSupport::Testing::TimeHelpers) for time-related specs
- Pundit policies go in `app/policies/` directory
- Role enum in models: use `enum :role, { key: value }, validate: true` syntax
- For custom validation messages, use I18n keys (e.g., `:user_already_member`) and add to `config/locales/en.yml`
- Factory Bot factories should set auto-generated attributes (like token, expires_at) to avoid nil issues in `build` calls

---

## 2026-01-10 - US-001
- Implemented Rails 7.2 API-mode project setup in /backend directory
- Files created/changed:
  - `/backend/` - Full Rails 7.2 API application
  - `/backend/docker-compose.yml` - PostgreSQL 16 and Redis 7 services
  - `/backend/app/controllers/health_controller.rb` - Health check endpoint
  - `/backend/spec/requests/health_spec.rb` - Health endpoint tests
  - `/backend/config/initializers/sidekiq.rb` - Sidekiq configuration
  - `/backend/.rubocop.yml` - Custom Rubocop configuration
- **Learnings for future iterations:**
  - Ruby 3.3.0 has compatibility issues with `connection_pool` gem - use Ruby 3.4.4 instead
  - Rubocop now uses `plugins:` instead of `require:` for loading extensions
  - Rails generates a nested .git directory - remove it for mono-repo structure
  - asdf uses `asdf set` command instead of `asdf local` in newer versions
  - Database names follow pattern: `entmoot_development`, `entmoot_test`
---

## 2026-01-10 - US-002
- Implemented React 18 frontend project setup in /frontend directory
- Files created/changed:
  - `/frontend/` - Full React 18 + TypeScript + Vite application
  - `/frontend/vite.config.ts` - Vite config with Tailwind, React, and proxy to Rails API
  - `/frontend/src/index.css` - Tailwind CSS v4 with shadcn/ui theme variables
  - `/frontend/src/App.tsx` - Main app with React Router and TanStack Query providers
  - `/frontend/src/lib/api.ts` - API fetch utility and QueryClient configuration
  - `/frontend/src/stores/auth.ts` - Zustand auth store with persistence
  - `/frontend/src/pages/Home.tsx` - Landing page with shadcn Button component
  - `/frontend/src/pages/NotFound.tsx` - 404 page
  - `/frontend/src/components/ui/button.tsx` - shadcn Button component
  - `/frontend/eslint.config.js` - ESLint with Prettier and React plugins
  - `/frontend/.prettierrc` - Prettier config with Tailwind plugin
- **Learnings for future iterations:**
  - Vite v7 requires Node.js 20.19+ or 22.12+ - nvm may override asdf, use `PATH="$HOME/.asdf/shims:$PATH"` prefix
  - shadcn/ui init requires `baseUrl` and `paths` in both tsconfig.json and tsconfig.app.json
  - Tailwind CSS v4 uses `@import "tailwindcss"` instead of `@tailwind` directives
  - shadcn/ui components export non-component items (like `buttonVariants`), add eslint-disable for `react-refresh/only-export-components`
  - Prettier tailwind plugin auto-sorts class names
---

## 2026-01-10 - US-003
- Implemented User Authentication - Backend with Devise and JWT
- Files created/changed:
  - `/backend/app/models/user.rb` - User model with devise + JWT authentication
  - `/backend/app/models/jwt_denylist.rb` - JWT denylist for token revocation
  - `/backend/app/models/refresh_token.rb` - Refresh token model with rotation
  - `/backend/config/initializers/devise.rb` - Devise configuration with JWT
  - `/backend/config/routes.rb` - Auth routes under /api/v1/auth namespace
  - `/backend/app/controllers/api/v1/auth/registrations_controller.rb` - Registration endpoint
  - `/backend/app/controllers/api/v1/auth/sessions_controller.rb` - Login/logout endpoints
  - `/backend/app/controllers/api/v1/auth/users_controller.rb` - Current user endpoint
  - `/backend/app/controllers/api/v1/auth/passwords_controller.rb` - Password reset endpoints
  - `/backend/app/controllers/api/v1/auth/tokens_controller.rb` - Refresh token endpoint
  - `/backend/app/controllers/api/v1/base_controller.rb` - Base controller with auth
  - `/backend/db/migrate/` - Migrations for users, jwt_denylist, refresh_tokens
  - `/backend/spec/factories/` - Factories for User and RefreshToken
  - `/backend/spec/models/` - Model specs for User and RefreshToken
  - `/backend/spec/requests/api/v1/auth/` - Request specs for all auth endpoints
  - `/backend/spec/support/auth_helpers.rb` - Helper for generating auth headers in tests
- **Learnings for future iterations:**
  - Don't inherit from Devise controllers (RegistrationsController, SessionsController) for API-mode - use standalone controllers with Devise internals
  - Use `User.find_for_database_authentication(email:)` and `user.valid_password?(password)` for manual login
  - Use `Warden::JWTAuth::UserEncoder.new.call(user, :user, nil).first` to generate JWT tokens
  - JWT denylist needs `jti` (JWT ID) and `exp` (expiration) fields for token revocation
  - Devise routes need `devise_for :users, skip: %i[sessions registrations]` but keep `:passwords` for reset email URL helper
  - Rubocop prefers `:unprocessable_content` over `:unprocessable_entity` (deprecation)
  - Time.at requires timezone: use `Time.zone.at()` instead of `Time.at()`
  - RefreshToken auto-generates token via `before_validation` callback, so presence validation doesn't work with shoulda-matchers
  - 72 tests pass covering all auth scenarios including token refresh, password reset, and revoked tokens
---

## 2026-01-10 - US-004
- Implemented User Authentication - Frontend with React Hook Form and Zod
- Files created/changed:
  - `/frontend/src/lib/auth.ts` - Auth API functions (login, register, logout, getCurrentUser, refreshToken)
  - `/frontend/src/stores/auth.ts` - Updated Zustand store with refreshToken and loading state
  - `/frontend/src/pages/Login.tsx` - Login page with form validation
  - `/frontend/src/pages/Register.tsx` - Registration page with password strength validation
  - `/frontend/src/pages/Dashboard.tsx` - Protected dashboard showing user info
  - `/frontend/src/components/ProtectedRoute.tsx` - Auth guard component
  - `/frontend/src/components/ui/input.tsx` - shadcn Input component
  - `/frontend/src/components/ui/label.tsx` - shadcn Label component
  - `/frontend/src/components/ui/card.tsx` - shadcn Card component
  - `/frontend/src/App.tsx` - Updated routes with auth-aware redirects
  - `/frontend/src/pages/Home.tsx` - Updated with auth-aware navigation
  - `/frontend/package.json` - Added react-hook-form, @hookform/resolvers, zod
- **Learnings for future iterations:**
  - Use React Hook Form with Zod resolver for declarative form validation
  - Zustand persist middleware stores state in localStorage under configured key name
  - When logout function checks for token before API call, make sure to not early-return if token is null - still clear local state and navigate
  - shadcn/ui components installed via `npx shadcn@latest add <component>` may need prettier auto-fix
  - AuthenticatedRedirect wrapper prevents logged-in users from accessing login/register pages
  - ProtectedRoute wrapper redirects unauthenticated users to login with return URL in state
  - Vite proxy to Rails API is configured in vite.config.ts under server.proxy
  - Rails server must be running on port 3000 for Vite proxy to work (default proxy target)
---

## 2026-01-10 - US-005
- Implemented Family Model and Management - Backend
- Files created/changed:
  - `/backend/app/models/family.rb` - Family model with name, timezone, settings (jsonb)
  - `/backend/app/models/family_membership.rb` - FamilyMembership join model with role enum (admin, adult, teen, child, observer)
  - `/backend/app/models/invitation.rb` - Invitation model with token, email, role, expires_at for member invites
  - `/backend/app/models/user.rb` - Updated with family associations and role helpers
  - `/backend/app/controllers/api/v1/families_controller.rb` - Family CRUD endpoints
  - `/backend/app/controllers/api/v1/invitations_controller.rb` - Invitation management endpoints
  - `/backend/app/controllers/api/v1/memberships_controller.rb` - Membership management endpoints
  - `/backend/app/controllers/api/v1/base_controller.rb` - Added Pundit authorization
  - `/backend/app/policies/` - Pundit policies for Family, FamilyMembership, Invitation
  - `/backend/db/migrate/` - Migrations for families, family_memberships, invitations tables
  - `/backend/config/routes.rb` - Added family, invitation, and membership routes
  - `/backend/config/locales/en.yml` - Custom validation message for duplicate membership
  - `/backend/spec/` - Factories, model specs, and request specs (91 new tests)
  - `/backend/spec/rails_helper.rb` - Added ActiveSupport::Testing::TimeHelpers
- **Learnings for future iterations:**
  - Pundit policies need `include Pundit::Authorization` in base controller and `rescue_from Pundit::NotAuthorizedError`
  - For join model scopes that reference same table twice, use raw SQL with aliased table names
  - `accept!` method on Invitation returns boolean for success/failure, uses transaction for atomicity
  - Factory Bot factories should provide values for auto-generated fields to avoid nil comparisons in tests
  - Use `have_attributes` matcher for multiple attribute checks on single object
  - RSpec/LetSetup cop prefers inline `create` in tests over unused `let!` declarations
  - For conditional SQL in Pundit scopes, use string interpolation with `<<~SQL.squish` heredoc
  - 163 total tests pass covering all family management scenarios
---
