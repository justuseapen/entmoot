# Ralph Progress Log
Started: Wed Jan 14 21:27:09 EST 2026
---

## Codebase Patterns
- Rails is API-only mode, so session/cookie middleware must be added explicitly via `config.middleware.use`
- Use `domain: :all` for cross-subdomain cookie support
- Use `same_site: :none` and `secure: true` (in production) for cross-origin cookie support
- ActionCable auth: Use `env['warden']&.user` to get authenticated user from session
- Session auth: Use `request.env["warden"].set_user(user, scope: :user, store: true)` to set user in session
- Session logout: Use `request.env["warden"].logout(:user)` to clear session
- API endpoints use JWT auth (`/api/v1/auth/me`), ActionCable uses session auth
- ActionCable connection specs: Use `type: :channel`, stub warden with `instance_double(Warden::Proxy, user: user)`, pass via `connect "/cable", env: { "warden" => warden }`
- Frontend WebSocket: Use `isAuthenticated` from auth store, not `token` - session cookies handle auth
- Stale connection prevention: Use connection ID counter to track effect runs, check before reconnect
---

## 2026-01-14 21:27 - US-001
- What was implemented: Added session cookie middleware to Rails API-only app
- Files changed:
  - backend/config/application.rb - Added ActionDispatch::Cookies and ActionDispatch::Session::CookieStore middleware
- **Learnings for future iterations:**
  - API-only Rails apps don't have session/cookie middleware by default - must add manually
  - Session cookie config: key: "_entmoot_session", domain: :all, same_site: :none, secure: Rails.env.production?
  - All 1618 existing tests pass with the middleware addition
---

## 2026-01-14 21:30 - US-002
- What was implemented: Updated ActionCable connection to use session auth instead of JWT
- Files changed:
  - backend/app/channels/application_cable/connection.rb - Replaced JWT token decoding with env['warden'] user lookup
- **Learnings for future iterations:**
  - `env['warden']&.user` is the simplest way to get the authenticated user from session in ActionCable
  - No need to use request.session directly - Warden handles session-based auth
  - The connection rejects unauthorized if no user found (returns nil to trigger reject_unauthorized_connection)
  - All 1618 existing tests still pass
---

## 2026-01-14 21:35 - US-003
- What was implemented: Added CORS expose header for Set-Cookie
- Files changed:
  - backend/config/initializers/cors.rb - Added `expose: %w[Set-Cookie]` to resource configuration
- **Learnings for future iterations:**
  - CORS `expose` option lists headers that browsers can access via JavaScript
  - Set-Cookie header must be exposed for cross-origin session cookie management
  - The expose option is an array of header names: `expose: %w[Set-Cookie]`
  - All 1618 existing tests still pass
---

## 2026-01-14 21:45 - US-004
- What was implemented: Added request specs for session-based authentication
- Files changed:
  - backend/app/controllers/api/v1/auth/sessions_controller.rb - Added warden.set_user on login, warden.logout on logout
  - backend/spec/requests/api/v1/auth/sessions_spec.rb - Added 5 new specs for session auth
- **Learnings for future iterations:**
  - Use `request.env["warden"].set_user(user, scope: :user, store: true)` to force session storage on login
  - Use `request.env["warden"].logout(:user)` to clear session on logout
  - Devise-JWT skips session storage by default (configured in devise.rb), so explicit set_user is needed
  - API endpoints still require JWT auth, but session is set for ActionCable to use
  - Session cookie name is `_entmoot_session` (configured in application.rb)
  - Response.cookies in RSpec provides access to cookies set in the response
  - All 1623 tests pass (5 new tests added)
---

## 2026-01-14 22:00 - US-005
- What was implemented: Added ActionCable connection spec for session-based authentication
- Files changed:
  - backend/spec/channels/application_cable/connection_spec.rb - Created new spec file with 3 tests
- **Learnings for future iterations:**
  - ActionCable connection specs use `type: :channel` and the `connect` helper method
  - Spec file path must match module structure: `spec/channels/application_cable/connection_spec.rb` (rubocop enforces this)
  - To test with warden auth, stub the warden object: `instance_double(Warden::Proxy, user: user)`
  - Pass warden stub via env hash: `connect "/cable", env: { "warden" => warden }`
  - Use `have_rejected_connection` matcher to test connection rejection
  - All 1626 tests pass (3 new channel tests added)
---

## 2026-01-14 21:45 - US-006
- What was implemented: Updated frontend WebSocket hook for session-based auth and graceful reconnection
- Files changed:
  - frontend/src/hooks/useNotificationWebSocket.ts - Major refactor for session auth
- **Learnings for future iterations:**
  - WebSocket URL no longer needs `?token=` - session cookies automatically sent by browser
  - Use `isAuthenticated` from auth store instead of `token` for effect dependencies
  - Connection ID pattern prevents stale connections: increment counter on each effect run, check before reconnect
  - Check stale state in onopen handler to immediately close connections that became stale during handshake
  - onclose handler must verify both connection ID match AND isAuthenticated before scheduling reconnect
  - TypeScript build passes, frontend tests pass (69 tests)
  - Verified full flow in browser: login→connect, logout→clean disconnect, re-login→reconnect
---
