# Ralph Progress Log
Started: January 2026

## Codebase Patterns
- Backend code lives in `/backend` directory (Rails 7.2 API-mode)
- Frontend code lives in `/frontend` directory (React 18 + TypeScript + Vite)
- Use Ruby 3.4.4 for compatibility with latest gems
- Use Node.js 22.13.1 for frontend (required by Vite v7)
- Run backend commands from the `/backend` directory
- Run frontend commands from the `/frontend` directory with `PATH="$HOME/.asdf/shims:$PATH"`
- Docker Compose services: `docker-compose up -d` for PostgreSQL and Redis
- RSpec tests: `bundle exec rspec`
- Rubocop linting: `bundle exec rubocop` (auto-fix: `bundle exec rubocop -A`)
- ESLint: `npm run lint` (auto-fix: `npm run lint -- --fix`)
- Build frontend: `npm run build`
- Rubocop uses `plugins:` syntax instead of `require:` for extensions
- All Ruby files must have `# frozen_string_literal: true` at the top
- Use double quotes for strings consistently
- Frontend uses `@/` path alias for imports (e.g., `@/components/ui/button`)
- shadcn/ui components live in `src/components/ui/`
- Auth endpoints under `/api/v1/auth/` namespace
- Use `auth_headers(user)` helper in request specs for authenticated requests
- JWT tokens generated with `Warden::JWTAuth::UserEncoder.new.call(user, :user, nil).first`
- Prefer `:unprocessable_content` over `:unprocessable_entity` (Rack deprecation)
- Use `Time.zone.at()` instead of `Time.at()` for timezone awareness
- Use `freeze_time` (from ActiveSupport::Testing::TimeHelpers) for time-related specs
- Pundit policies go in `app/policies/` directory
- Role enum in models: use `enum :role, { key: value }, validate: true` syntax
- For custom validation messages, use I18n keys (e.g., `:user_already_member`) and add to `config/locales/en.yml`
- Factory Bot factories should set auto-generated attributes (like token, expires_at) to avoid nil issues in `build` calls
- ActionCable WebSocket auth: pass JWT token as query param `?token=...` and decode with `Warden::JWTAuth::TokenDecoder`
- Use `ReturnType<typeof setTimeout>` instead of `NodeJS.Timeout` for browser-compatible timeout types
- NotificationService.create_and_broadcast handles both DB persistence and WebSocket broadcast
- Anthropic gem (alexrudall/anthropic v0.4.1) uses Faraday errors, not custom error classes
- Rack::Attack rate limiting: configure in initializer, add middleware in config/application.rb
- Service specs: mock at class level when service creates dependencies in initialize

---

## 2026-01-10 - US-001
- Implemented Rails 7.2 API-mode project setup in /backend directory
- Files created/changed:
  - `/backend/` - Full Rails 7.2 API application
  - `/backend/docker-compose.yml` - PostgreSQL 16 and Redis 7 services
  - `/backend/app/controllers/health_controller.rb` - Health check endpoint
  - `/backend/spec/requests/health_spec.rb` - Health endpoint tests
  - `/backend/config/initializers/sidekiq.rb` - Sidekiq configuration
  - `/backend/.rubocop.yml` - Custom Rubocop configuration
- **Learnings for future iterations:**
  - Ruby 3.3.0 has compatibility issues with `connection_pool` gem - use Ruby 3.4.4 instead
  - Rubocop now uses `plugins:` instead of `require:` for loading extensions
  - Rails generates a nested .git directory - remove it for mono-repo structure
  - asdf uses `asdf set` command instead of `asdf local` in newer versions
  - Database names follow pattern: `entmoot_development`, `entmoot_test`
---

## 2026-01-10 - US-002
- Implemented React 18 frontend project setup in /frontend directory
- Files created/changed:
  - `/frontend/` - Full React 18 + TypeScript + Vite application
  - `/frontend/vite.config.ts` - Vite config with Tailwind, React, and proxy to Rails API
  - `/frontend/src/index.css` - Tailwind CSS v4 with shadcn/ui theme variables
  - `/frontend/src/App.tsx` - Main app with React Router and TanStack Query providers
  - `/frontend/src/lib/api.ts` - API fetch utility and QueryClient configuration
  - `/frontend/src/stores/auth.ts` - Zustand auth store with persistence
  - `/frontend/src/pages/Home.tsx` - Landing page with shadcn Button component
  - `/frontend/src/pages/NotFound.tsx` - 404 page
  - `/frontend/src/components/ui/button.tsx` - shadcn Button component
  - `/frontend/eslint.config.js` - ESLint with Prettier and React plugins
  - `/frontend/.prettierrc` - Prettier config with Tailwind plugin
- **Learnings for future iterations:**
  - Vite v7 requires Node.js 20.19+ or 22.12+ - nvm may override asdf, use `PATH="$HOME/.asdf/shims:$PATH"` prefix
  - shadcn/ui init requires `baseUrl` and `paths` in both tsconfig.json and tsconfig.app.json
  - Tailwind CSS v4 uses `@import "tailwindcss"` instead of `@tailwind` directives
  - shadcn/ui components export non-component items (like `buttonVariants`), add eslint-disable for `react-refresh/only-export-components`
  - Prettier tailwind plugin auto-sorts class names
---

## 2026-01-10 - US-003
- Implemented User Authentication - Backend with Devise and JWT
- Files created/changed:
  - `/backend/app/models/user.rb` - User model with devise + JWT authentication
  - `/backend/app/models/jwt_denylist.rb` - JWT denylist for token revocation
  - `/backend/app/models/refresh_token.rb` - Refresh token model with rotation
  - `/backend/config/initializers/devise.rb` - Devise configuration with JWT
  - `/backend/config/routes.rb` - Auth routes under /api/v1/auth namespace
  - `/backend/app/controllers/api/v1/auth/registrations_controller.rb` - Registration endpoint
  - `/backend/app/controllers/api/v1/auth/sessions_controller.rb` - Login/logout endpoints
  - `/backend/app/controllers/api/v1/auth/users_controller.rb` - Current user endpoint
  - `/backend/app/controllers/api/v1/auth/passwords_controller.rb` - Password reset endpoints
  - `/backend/app/controllers/api/v1/auth/tokens_controller.rb` - Refresh token endpoint
  - `/backend/app/controllers/api/v1/base_controller.rb` - Base controller with auth
  - `/backend/db/migrate/` - Migrations for users, jwt_denylist, refresh_tokens
  - `/backend/spec/factories/` - Factories for User and RefreshToken
  - `/backend/spec/models/` - Model specs for User and RefreshToken
  - `/backend/spec/requests/api/v1/auth/` - Request specs for all auth endpoints
  - `/backend/spec/support/auth_helpers.rb` - Helper for generating auth headers in tests
- **Learnings for future iterations:**
  - Don't inherit from Devise controllers (RegistrationsController, SessionsController) for API-mode - use standalone controllers with Devise internals
  - Use `User.find_for_database_authentication(email:)` and `user.valid_password?(password)` for manual login
  - Use `Warden::JWTAuth::UserEncoder.new.call(user, :user, nil).first` to generate JWT tokens
  - JWT denylist needs `jti` (JWT ID) and `exp` (expiration) fields for token revocation
  - Devise routes need `devise_for :users, skip: %i[sessions registrations]` but keep `:passwords` for reset email URL helper
  - Rubocop prefers `:unprocessable_content` over `:unprocessable_entity` (deprecation)
  - Time.at requires timezone: use `Time.zone.at()` instead of `Time.at()`
  - RefreshToken auto-generates token via `before_validation` callback, so presence validation doesn't work with shoulda-matchers
  - 72 tests pass covering all auth scenarios including token refresh, password reset, and revoked tokens
---

## 2026-01-10 - US-004
- Implemented User Authentication - Frontend with React Hook Form and Zod
- Files created/changed:
  - `/frontend/src/lib/auth.ts` - Auth API functions (login, register, logout, getCurrentUser, refreshToken)
  - `/frontend/src/stores/auth.ts` - Updated Zustand store with refreshToken and loading state
  - `/frontend/src/pages/Login.tsx` - Login page with form validation
  - `/frontend/src/pages/Register.tsx` - Registration page with password strength validation
  - `/frontend/src/pages/Dashboard.tsx` - Protected dashboard showing user info
  - `/frontend/src/components/ProtectedRoute.tsx` - Auth guard component
  - `/frontend/src/components/ui/input.tsx` - shadcn Input component
  - `/frontend/src/components/ui/label.tsx` - shadcn Label component
  - `/frontend/src/components/ui/card.tsx` - shadcn Card component
  - `/frontend/src/App.tsx` - Updated routes with auth-aware redirects
  - `/frontend/src/pages/Home.tsx` - Updated with auth-aware navigation
  - `/frontend/package.json` - Added react-hook-form, @hookform/resolvers, zod
- **Learnings for future iterations:**
  - Use React Hook Form with Zod resolver for declarative form validation
  - Zustand persist middleware stores state in localStorage under configured key name
  - When logout function checks for token before API call, make sure to not early-return if token is null - still clear local state and navigate
  - shadcn/ui components installed via `npx shadcn@latest add <component>` may need prettier auto-fix
  - AuthenticatedRedirect wrapper prevents logged-in users from accessing login/register pages
  - ProtectedRoute wrapper redirects unauthenticated users to login with return URL in state
  - Vite proxy to Rails API is configured in vite.config.ts under server.proxy
  - Rails server must be running on port 3000 for Vite proxy to work (default proxy target)
---

## 2026-01-10 - US-005
- Implemented Family Model and Management - Backend
- Files created/changed:
  - `/backend/app/models/family.rb` - Family model with name, timezone, settings (jsonb)
  - `/backend/app/models/family_membership.rb` - FamilyMembership join model with role enum (admin, adult, teen, child, observer)
  - `/backend/app/models/invitation.rb` - Invitation model with token, email, role, expires_at for member invites
  - `/backend/app/models/user.rb` - Updated with family associations and role helpers
  - `/backend/app/controllers/api/v1/families_controller.rb` - Family CRUD endpoints
  - `/backend/app/controllers/api/v1/invitations_controller.rb` - Invitation management endpoints
  - `/backend/app/controllers/api/v1/memberships_controller.rb` - Membership management endpoints
  - `/backend/app/controllers/api/v1/base_controller.rb` - Added Pundit authorization
  - `/backend/app/policies/` - Pundit policies for Family, FamilyMembership, Invitation
  - `/backend/db/migrate/` - Migrations for families, family_memberships, invitations tables
  - `/backend/config/routes.rb` - Added family, invitation, and membership routes
  - `/backend/config/locales/en.yml` - Custom validation message for duplicate membership
  - `/backend/spec/` - Factories, model specs, and request specs (91 new tests)
  - `/backend/spec/rails_helper.rb` - Added ActiveSupport::Testing::TimeHelpers
- **Learnings for future iterations:**
  - Pundit policies need `include Pundit::Authorization` in base controller and `rescue_from Pundit::NotAuthorizedError`
  - For join model scopes that reference same table twice, use raw SQL with aliased table names
  - `accept!` method on Invitation returns boolean for success/failure, uses transaction for atomicity
  - Factory Bot factories should provide values for auto-generated fields to avoid nil comparisons in tests
  - Use `have_attributes` matcher for multiple attribute checks on single object
  - RSpec/LetSetup cop prefers inline `create` in tests over unused `let!` declarations
  - For conditional SQL in Pundit scopes, use string interpolation with `<<~SQL.squish` heredoc
  - 163 total tests pass covering all family management scenarios
---

## 2026-01-10 - US-007
- Implemented Pet Profiles - Backend
- Files created/changed:
  - `/backend/app/models/pet.rb` - Pet model with name, pet_type, avatar_url, birthday, notes
  - `/backend/app/models/family.rb` - Added has_many :pets association
  - `/backend/app/models/family_membership.rb` - Added can_manage_pets? helper method
  - `/backend/app/controllers/api/v1/pets_controller.rb` - Full CRUD endpoints for pets
  - `/backend/app/policies/pet_policy.rb` - Pundit policy restricting to admin/adult roles
  - `/backend/db/migrate/20260110205446_create_pets.rb` - Migration with unique index on family_id + name
  - `/backend/config/routes.rb` - Added pets resource nested under families
  - `/backend/config/locales/en.yml` - Added custom validation message for duplicate pet names
  - `/backend/spec/factories/pets.rb` - Pet factory with dog/cat traits
  - `/backend/spec/models/pet_spec.rb` - Model specs for validations and associations
  - `/backend/spec/models/family_spec.rb` - Added pets association test
  - `/backend/spec/requests/api/v1/pets_spec.rb` - Full request specs (40 new tests)
- **Learnings for future iterations:**
  - For nested resource policies, use `authorize @family, policy_class: PetPolicy` for index action
  - Add unique index on composite keys (family_id, name) to enforce uniqueness at DB level
  - Use I18n key `:taken_in_family` for custom uniqueness validation message
  - RSpec's `pluck("id")` is preferred over `map { |p| p["id"] }` for extracting values
  - Split specs with too many expectations (RSpec/MultipleExpectations cop) into separate tests
  - 203 total tests pass (40 new pet-related tests)
---

## 2026-01-10 - US-008
- Implemented Pet Profiles - Frontend
- Files created/changed:
  - `/frontend/src/components/PetCard.tsx` - Pet card displaying avatar/emoji, name, type, birthday/age, notes
  - `/frontend/src/components/PetModal.tsx` - Add/edit pet modal with form validation (name, type, photo URL, birthday, notes)
  - `/frontend/src/components/PetsList.tsx` - Pet grid with add/edit/delete functionality and delete confirmation dialog
  - `/frontend/src/hooks/usePets.ts` - TanStack Query hooks for CRUD operations with query key management
  - `/frontend/src/lib/pets.ts` - API functions for pet endpoints and pet type emoji mapping
  - `/frontend/src/pages/FamilySettings.tsx` - Added PetsList component to family hub
- **Learnings for future iterations:**
  - Pet emoji fallbacks use normalized lowercase with underscores (e.g., "guinea pig" -> "guinea_pig")
  - Age calculation handles both years and months for young pets (< 1 year shows months)
  - Role-based access: canManagePets checks for "admin" or "adult" roles
  - TanStack Query key pattern: `["pets", "list", familyId]` for list, `["pets", "detail", familyId, petId]` for single
  - Form reset in modals: use useEffect with [open, pet, reset] dependencies to reset on open/close/pet change
  - Select component needs controlled value and onValueChange to work with react-hook-form
---

## 2026-01-10 - US-009
- Implemented SMART Goals Model - Backend
- Files created/changed:
  - `/backend/app/models/goal.rb` - Goal model with SMART fields, time_scale/status/visibility enums, parent-child hierarchy
  - `/backend/app/models/goal_assignment.rb` - GoalAssignment join model for multi-member assignment
  - `/backend/app/controllers/api/v1/goals_controller.rb` - Full CRUD endpoints with filtering
  - `/backend/app/policies/goal_policy.rb` - Pundit policy with visibility rules (personal/shared/family)
  - `/backend/db/migrate/20260110213749_create_goals.rb` - Goals table migration
  - `/backend/db/migrate/20260110213814_create_goal_assignments.rb` - GoalAssignments table migration
  - `/backend/config/routes.rb` - Added goals resource nested under families
  - `/backend/config/locales/en.yml` - Added validation messages for goal_assignment
  - `/backend/app/models/user.rb` - Added created_goals, goal_assignments, assigned_goals associations
  - `/backend/app/models/family.rb` - Added goals association
  - `/backend/spec/factories/goals.rb` - Goal factory with traits for all enums and SMART fields
  - `/backend/spec/factories/goal_assignments.rb` - GoalAssignment factory
  - `/backend/spec/models/goal_spec.rb` - Model specs (44 tests)
  - `/backend/spec/models/goal_assignment_spec.rb` - Model specs (6 tests)
  - `/backend/spec/requests/api/v1/goals_spec.rb` - Request specs (52 tests)
- **Learnings for future iterations:**
  - For Pundit policy scope with complex visibility rules, use raw SQL with heredoc format (<<~SQL.squish)
  - Goal visibility: personal=creator only, shared=creator+assigned users, family=all family members
  - Scope lambdas should be multi-line for readability when they have conditionals
  - Split large controller response methods into smaller helper methods to satisfy ABC complexity metrics
  - Use `params.dig(:goal, :assignee_ids)` instead of `params[:goal][:assignee_ids]` for safer nil handling
  - TanStack Query key pattern for goals: `["goals", "list", familyId]`, `["goals", "detail", familyId, goalId]`
  - 102 new goal-related tests added, 305 total tests pass
---

## 2026-01-10 - US-010
- Implemented SMART Goals - Frontend
- Files created/changed:
  - `/frontend/src/pages/Goals.tsx` - Goal browser page with filtering by time scale, status, assignee
  - `/frontend/src/components/GoalCard.tsx` - Goal card displaying title, description, time scale badge, status badge, progress bar, assignees, edit/delete buttons
  - `/frontend/src/components/GoalModal.tsx` - Create/edit goal modal with Quick Form and SMART Wizard modes
  - `/frontend/src/components/GoalDetailView.tsx` - Goal detail dialog showing all fields, progress slider, status dropdown
  - `/frontend/src/hooks/useGoals.ts` - TanStack Query hooks for goal CRUD operations
  - `/frontend/src/lib/goals.ts` - API functions, type definitions, and helper utilities
  - `/frontend/src/components/ui/progress.tsx` - shadcn Progress component
  - `/frontend/src/components/ui/slider.tsx` - shadcn Slider component
  - `/frontend/src/components/ui/tabs.tsx` - shadcn Tabs component
  - `/frontend/src/components/ui/textarea.tsx` - shadcn Textarea component
  - `/frontend/src/App.tsx` - Added /families/:id/goals route
  - `/frontend/src/pages/FamilySettings.tsx` - Added link to Goals page
- **Learnings for future iterations:**
  - Goal modal supports two modes: Quick Form (single form with tabs) and SMART Wizard (step-by-step)
  - Wizard has 7 steps: Basic Info, Specific, Measurable, Achievable, Relevant, Time-Bound, Settings
  - Parent goal selector filters out daily goals and the current goal being edited
  - canManageGoals checks for admin/adult/teen roles
  - Goal cards check if current user is the creator for edit/delete permissions
  - GoalDetailView fetches goal details separately to get SMART fields (not included in list response)
  - Progress update in detail view uses local state with cancel/save buttons
  - Status change in detail view updates immediately on select change
---

## 2026-01-10 - US-011
- Implemented Goal Hierarchy Visualization
- Files created/changed:
  - `/frontend/src/pages/GoalTree.tsx` - Goal tree page with member filtering, time scale legend, empty state guidance
  - `/frontend/src/components/GoalTreeNode.tsx` - Recursive tree node component with expand/collapse, visual connectors
  - `/frontend/src/pages/Goals.tsx` - Added "Tree View" link button in header
  - `/frontend/src/App.tsx` - Added /families/:id/goals/tree route
- **Learnings for future iterations:**
  - Tree visualization can be built with pure CSS connectors (no library needed)
  - Use recursive component pattern for tree nodes with level prop for indentation
  - Color-code by time scale using consistent color mapping (red=annual, yellow=quarterly, green=monthly, blue=weekly, purple=daily)
  - Auto-expand first 2 levels (level < 2) for good UX on initial load
  - TIME_SCALE_ORDER array useful for sorting goals from annual down to daily
  - Filter by member should check both creator.id and assignees for goal ownership
  - hasLinkedGoals check (any goal.parent_id !== null) determines whether to show empty state guidance
  - GoalDetailView can be reused from Goals page for clicking tree nodes
---

## 2026-01-11 - US-012
- Implemented Daily Planning - Backend
- Files created/changed:
  - `/backend/app/models/daily_plan.rb` - DailyPlan model with date, user, family, intention fields
  - `/backend/app/models/daily_task.rb` - DailyTask model with title, completed, position, optional goal link
  - `/backend/app/models/top_priority.rb` - TopPriority model (max 3) with priority_order validation
  - `/backend/app/controllers/api/v1/daily_plans_controller.rb` - today/show/update endpoints
  - `/backend/app/policies/daily_plan_policy.rb` - Pundit policy for daily plan authorization
  - `/backend/db/migrate/20260111005438_create_daily_plans.rb` - DailyPlans table
  - `/backend/db/migrate/20260111005453_create_daily_tasks.rb` - DailyTasks table
  - `/backend/db/migrate/20260111005508_create_top_priorities.rb` - TopPriorities table
  - `/backend/config/routes.rb` - Added daily_plans routes under families
  - `/backend/config/locales/en.yml` - Added validation messages for daily planning
  - `/backend/app/models/user.rb` - Added daily_plans association
  - `/backend/app/models/family.rb` - Added daily_plans association
  - `/backend/spec/factories/daily_plans.rb` - DailyPlan factory with traits
  - `/backend/spec/factories/daily_tasks.rb` - DailyTask factory with traits
  - `/backend/spec/factories/top_priorities.rb` - TopPriority factory with traits
  - `/backend/spec/models/daily_plan_spec.rb` - Model specs (21 tests)
  - `/backend/spec/models/daily_task_spec.rb` - Model specs (14 tests)
  - `/backend/spec/models/top_priority_spec.rb` - Model specs (9 tests)
  - `/backend/spec/requests/api/v1/daily_plans_spec.rb` - Request specs (26 tests)
- **Learnings for future iterations:**
  - DailyPlan.find_or_create_for_today uses family's timezone to determine "today"
  - Use `Time.find_zone(family.timezone)&.today` for timezone-aware date calculation
  - TopPriority has max of 3 per day, enforced by priority_order range (1..3) and custom validation
  - DailyTask has auto-position via before_validation callback - don't validate presence of position
  - accepts_nested_attributes_for enables updating tasks/priorities in single PATCH request
  - Split controller response methods to satisfy ABC complexity metrics (plan_attributes + plan_associations)
  - For shoulda-matchers on auto-generated fields, use explicit subject with build(:factory) to avoid false positives
  - 371 total tests pass (66 new daily planning tests)
---

## 2026-01-11 - US-013
- Implemented Daily Planning - Frontend
- Files created/changed:
  - `/frontend/src/pages/DailyPlanner.tsx` - Main daily planner page with all functionality
  - `/frontend/src/components/SortableTaskItem.tsx` - Draggable task item component using @dnd-kit
  - `/frontend/src/components/ui/checkbox.tsx` - shadcn/ui checkbox component
  - `/frontend/src/hooks/useDailyPlans.ts` - TanStack Query hooks for daily plan API
  - `/frontend/src/lib/dailyPlans.ts` - API functions and TypeScript types for daily plans
  - `/frontend/src/App.tsx` - Added /families/:id/planner route
  - `/frontend/src/pages/Dashboard.tsx` - Added "Start Daily Planning" quick action link
  - `/frontend/package.json` - Added @dnd-kit/* and @radix-ui/react-checkbox dependencies
- **Learnings for future iterations:**
  - @dnd-kit requires SortableContext with items array of unique IDs (use `task-${task.id}` pattern)
  - Use useSortable hook in child component for draggable items
  - Local state pattern for optimistic updates: track localState separate from server state, merge with ?? operator
  - Save on blur for text inputs (priorities, intention) to avoid excessive API calls
  - Save immediately for task actions (add, toggle, remove, reorder) for responsive UX
  - Use `_destroy: true` pattern with Rails accepts_nested_attributes_for to mark items for deletion
  - Filter visibleTasks = tasks.filter(t => !t._destroy) to hide pending deletions from UI
  - ensureThreePriorities helper ensures exactly 3 priority inputs always shown
  - Progress bar calculation: Math.round((completed.length / total.length) * 100)
---

## 2026-01-11 - US-014
- Implemented Evening Reflection - Backend
- Files created/changed:
  - `/backend/app/models/reflection.rb` - Reflection model with reflection_type, mood, energy_level, gratitude_items
  - `/backend/app/models/reflection_response.rb` - ReflectionResponse model for prompt-response pairs
  - `/backend/app/controllers/api/v1/reflections_controller.rb` - CRUD endpoints for reflections
  - `/backend/app/controllers/api/v1/reflection_prompts_controller.rb` - Public endpoint for prompts
  - `/backend/app/policies/reflection_policy.rb` - Pundit policy for authorization
  - `/backend/config/reflection_prompts.yml` - Prompts for evening, weekly, monthly, quarterly, annual reflections
  - `/backend/db/migrate/20260111014621_create_reflections.rb` - Reflections table
  - `/backend/db/migrate/20260111014633_create_reflection_responses.rb` - Reflection responses table
  - `/backend/config/locales/en.yml` - Added validation messages for reflections
  - `/backend/config/routes.rb` - Added reflections and reflection_prompts routes
  - `/backend/spec/factories/reflections.rb` - Factory with traits for each reflection type
  - `/backend/spec/factories/reflection_responses.rb` - Factory for reflection responses
  - `/backend/spec/models/reflection_spec.rb` - Model specs (17 tests)
  - `/backend/spec/models/reflection_response_spec.rb` - Model specs (7 tests)
  - `/backend/spec/requests/api/v1/reflections_spec.rb` - Request specs (34 tests)
  - `/backend/spec/requests/api/v1/reflection_prompts_spec.rb` - Request specs (6 tests)
- **Learnings for future iterations:**
  - Optional enum fields should NOT use `validate: true` - it prevents nil values
  - Split large response builder methods (reflection_attributes, reflection_associations) to satisfy ABC metrics
  - Use `backed_by_column_of_type(:integer)` in enum matchers when not validating
  - Database default for enum fields (e.g., reflection_type default: 0) means presence validation always passes
  - Reflection prompts can be public endpoint (skip_before_action :authenticate_user!)
  - Use YAML file for configurable prompts - easy to update without code changes
  - accepts_nested_attributes_for with allow_destroy enables full CRUD on responses in single request
  - 435 total tests pass (64 new reflection tests)
---

## 2026-01-11 - US-015
- Implemented Evening Reflection - Frontend
- Files created/changed:
  - `/frontend/src/lib/reflections.ts` - API functions, types, and constants for reflections (Mood, ReflectionType, prompts)
  - `/frontend/src/hooks/useReflections.ts` - TanStack Query hooks for reflection CRUD operations
  - `/frontend/src/pages/EveningReflection.tsx` - Main evening reflection page with guided prompts
  - `/frontend/src/App.tsx` - Added /families/:id/reflection route
  - `/frontend/src/pages/Dashboard.tsx` - Added Evening Reflection link in Quick Actions
  - `/frontend/src/pages/DailyPlanner.tsx` - Added Evening Reflection navigation button
- **Learnings for future iterations:**
  - Reflection prompts API returns different structure for single type vs all types - check if array or object
  - Use local state pattern for multi-step wizard (currentStep, showPastReflections)
  - Reflection can be created/updated via same form - check for existingReflectionId
  - Mood selector: use button group with emoji display, toggle on/off with same click
  - Energy slider uses Slider component with value prop as array [energyLevel]
  - Past reflections view is same component with showPastReflections state toggle
  - Soft purple gradient (from-indigo-50 to-purple-50) creates calm evening atmosphere
---

## 2026-01-11 - US-016
- Implemented Weekly Review - Backend
- Files created/changed:
  - `/backend/app/models/weekly_review.rb` - WeeklyReview model with metrics calculation methods
  - `/backend/app/controllers/api/v1/weekly_reviews_controller.rb` - Full CRUD + /current + /metrics endpoints
  - `/backend/app/policies/weekly_review_policy.rb` - Pundit policy for authorization
  - `/backend/db/migrate/20260111064605_create_weekly_reviews.rb` - Migration with unique index
  - `/backend/config/routes.rb` - Added weekly_reviews routes under families
  - `/backend/config/locales/en.yml` - Added validation messages for weekly_review
  - `/backend/app/models/user.rb` - Added weekly_reviews association
  - `/backend/app/models/family.rb` - Added weekly_reviews association
  - `/backend/spec/factories/weekly_reviews.rb` - Factory with traits
  - `/backend/spec/models/weekly_review_spec.rb` - Model specs (22 tests)
  - `/backend/spec/requests/api/v1/weekly_reviews_spec.rb` - Request specs (29 tests)
- **Learnings for future iterations:**
  - Week start day is configurable per family via settings["week_start_day"] (0=Sunday, 1=Monday)
  - Use `(today.wday - week_start_day) % 7` to calculate days since week start
  - For complex metrics methods, split into smaller private helpers to satisfy ABC complexity metrics
  - jsonb arrays with defaults: `default: []` in migration prevents nil issues
  - visible_goals query: use named parameters in SQL string for readability
  - 486 total tests pass (51 new weekly review tests)
---

## 2026-01-11 - US-017
- Implemented Weekly Review - Frontend with guided wizard workflow
- Files created/changed:
  - `/frontend/src/lib/weeklyReviews.ts` - API functions, types, helper utilities (formatWeekRange, getWeekNumber, WEEKLY_REVIEW_STEPS)
  - `/frontend/src/hooks/useWeeklyReviews.ts` - TanStack Query hooks for weekly review CRUD operations
  - `/frontend/src/pages/WeeklyReview.tsx` - Main weekly review page with 5-step wizard
  - `/frontend/src/App.tsx` - Added /families/:id/weekly-review route
  - `/frontend/src/pages/Dashboard.tsx` - Added Weekly Review quick action link
  - `/frontend/src/pages/DailyPlanner.tsx` - Added Weekly Review navigation link
- **Learnings for future iterations:**
  - Weekly review wizard follows same pattern as EveningReflection (local state, step navigation, save/resume)
  - Metrics come from backend WeeklyReview.metrics method (task_completion, goal_progress)
  - Use warm amber gradient (from-amber-50 to-orange-50) for weekly review atmosphere vs purple for evening reflection
  - Array input pattern: keep an empty string at end to allow adding new items, filter empty strings before saving
  - Priority inputs: ensure minimum of 3 shown, allow up to 5 with add/remove buttons
  - Past reviews filtered by excluding currentReview?.id from the list
  - formatWeekRange helper creates user-friendly date range display (e.g., "Jan 6 - Jan 12, 2026")
---

## 2026-01-11 - US-018
- Implemented Notification Preferences - Backend
- Files created/changed:
  - `/backend/app/models/notification_preference.rb` - NotificationPreference model with channel/reminder/quiet hours preferences
  - `/backend/app/controllers/api/v1/notification_preferences_controller.rb` - GET/PATCH endpoints for user preferences
  - `/backend/db/migrate/20260111070235_create_notification_preferences.rb` - Migration with all preference fields
  - `/backend/config/routes.rb` - Added /users/me/notification_preferences routes
  - `/backend/config/locales/en.yml` - Added validation messages for time format
  - `/backend/app/models/user.rb` - Added has_one :notification_preference association
  - `/backend/spec/factories/notification_preferences.rb` - Factory with traits for different configurations
  - `/backend/spec/models/notification_preference_spec.rb` - Model specs (37 tests)
  - `/backend/spec/requests/api/v1/notification_preferences_spec.rb` - Request specs (31 tests)
- **Learnings for future iterations:**
  - User-scoped preferences route: use `scope "users/me"` with singular `resource` instead of `resources`
  - Time format validation regex: `/\A([01]\d|2[0-3]):([0-5]\d)\z/` validates HH:MM format (00:00-23:59)
  - Predicate private methods should end with `?` (e.g., `in_range?` not `check_within_range`)
  - Split complex methods to satisfy ABC complexity (within_quiet_hours? and next_reminder_time)
  - Use `find_or_create_for(user)` pattern for ensuring user has preferences on first access
  - Response JSON structured with nested objects: channels, reminders (with enabled/time), quiet_hours
  - 554 total tests pass (68 new notification preferences tests)
---

## 2026-01-11 - US-019
- Implemented Notification Preferences - Frontend
- Files created/changed:
  - `/frontend/src/lib/notificationPreferences.ts` - API functions, types, and helper utilities (formatTimeDisplay, generateTimeOptions, getSchedulePreview, DAYS_OF_WEEK)
  - `/frontend/src/hooks/useNotificationPreferences.ts` - TanStack Query hooks for GET and PATCH operations
  - `/frontend/src/pages/NotificationSettings.tsx` - Full notification settings page with channel toggles, reminder toggles with time pickers, quiet hours range picker, schedule preview
  - `/frontend/src/components/ui/switch.tsx` - shadcn/ui Switch component
  - `/frontend/src/App.tsx` - Added /settings/notifications route
  - `/frontend/src/pages/Dashboard.tsx` - Added "Notification Settings" link in footer
- **Learnings for future iterations:**
  - Notification preferences API uses flat params for update but nested structure for response
  - generateTimeOptions creates 30-minute intervals for time pickers (00:00 to 23:30)
  - Use formatTimeDisplay helper to convert HH:MM to 12-hour format with AM/PM
  - Schedule preview uses getSchedulePreview to show human-readable reminder schedule
  - Switch component from shadcn/ui uses onCheckedChange instead of onChange
  - DAYS_OF_WEEK array maps 0-6 to Sunday-Saturday for weekly review day selector
  - Save on toggle change for immediate feedback (no form submit needed)
  - Show success message with auto-clear timeout for better UX
---

## 2026-01-11 - US-020
- Implemented In-App Notifications with real-time delivery via ActionCable
- Files created/changed:
  - `/backend/app/models/notification.rb` - Notification model with user_id, title, body, read, link, notification_type
  - `/backend/app/controllers/api/v1/notifications_controller.rb` - index, mark_as_read, mark_all_as_read endpoints
  - `/backend/app/channels/notifications_channel.rb` - ActionCable channel for streaming to user
  - `/backend/app/channels/application_cable/connection.rb` - JWT authentication for WebSocket connections
  - `/backend/app/policies/notification_policy.rb` - Pundit policy for authorization
  - `/backend/app/services/notification_service.rb` - Service for creating and broadcasting notifications
  - `/backend/db/migrate/20260111203405_create_notifications.rb` - Migration with indexes
  - `/backend/config/routes.rb` - Added notifications routes
  - `/backend/app/models/user.rb` - Added has_many :notifications association
  - `/backend/spec/factories/notifications.rb` - Factory with traits for all notification types
  - `/backend/spec/models/notification_spec.rb` - Model specs (11 tests)
  - `/backend/spec/requests/api/v1/notifications_spec.rb` - Request specs (20 tests)
  - `/frontend/src/lib/notifications.ts` - API functions, types, and helper utilities
  - `/frontend/src/hooks/useNotifications.ts` - TanStack Query hooks for notifications CRUD
  - `/frontend/src/hooks/useNotificationWebSocket.ts` - WebSocket hook for real-time updates
  - `/frontend/src/components/NotificationBell.tsx` - Bell icon with badge and dropdown
  - `/frontend/src/pages/Notifications.tsx` - Full notifications page for "view all"
  - `/frontend/src/App.tsx` - Added NotificationWebSocketInitializer and /notifications route
  - `/frontend/src/pages/Dashboard.tsx` - Added NotificationBell to header
  - `/frontend/src/components/ui/popover.tsx` - shadcn/ui popover component
  - `/frontend/src/components/ui/dropdown-menu.tsx` - shadcn/ui dropdown menu component
- **Learnings for future iterations:**
  - ActionCable JWT auth: use Warden::JWTAuth::TokenDecoder to decode token from query params
  - String enum (not integer): use `{ general: "general", ... }` format for notification_type
  - WebSocket URL: use wsProtocol based on window.location.protocol (ws: vs wss:)
  - Avoid useCallback recursive reference: define connect() as regular function inside useEffect
  - Use `ReturnType<typeof setTimeout>` instead of `NodeJS.Timeout` for browser compatibility
  - NotificationsChannel.broadcast_to_user is a class method that calls broadcast_to(user, data)
  - Use update_all with rubocop disable for bulk updates (# rubocop:disable Rails/SkipsModelValidations)
  - Popover from shadcn/ui works well for notification dropdown with controlled open state
  - Refetch interval (30s) provides polling fallback when WebSocket disconnects
  - 584 total tests pass (31 new notification tests)
---

## 2026-01-11 - US-021
- Implemented Email Notifications with scheduled Sidekiq jobs and ReminderMailer
- Files created/changed:
  - `/backend/app/mailers/reminder_mailer.rb` - ReminderMailer with 4 email types (morning_planning, evening_reflection, weekly_review, goal_check_in)
  - `/backend/app/mailers/application_mailer.rb` - Updated default from address
  - `/backend/app/views/layouts/mailer.html.erb` - Mobile-friendly HTML email layout with unsubscribe link
  - `/backend/app/views/reminder_mailer/*.html.erb` - HTML templates for all 4 email types
  - `/backend/app/views/reminder_mailer/*.text.erb` - Plain text templates for all 4 email types
  - `/backend/app/jobs/send_morning_planning_reminders_job.rb` - Scheduled job for morning reminders
  - `/backend/app/jobs/send_evening_reflection_reminders_job.rb` - Scheduled job for evening reminders
  - `/backend/app/jobs/send_weekly_review_reminders_job.rb` - Scheduled job for weekly review reminders
  - `/backend/app/jobs/send_goal_check_in_reminders_job.rb` - Scheduled job for goal check-in reminders
  - `/backend/app/controllers/api/v1/email_subscriptions_controller.rb` - One-click unsubscribe endpoint
  - `/backend/config/sidekiq.yml` - Sidekiq scheduler configuration for reminder jobs
  - `/backend/config/initializers/sidekiq.rb` - Sidekiq-scheduler plugin configuration
  - `/backend/config/environments/development.rb` - Letter Opener configuration for development
  - `/backend/config/routes.rb` - Added unsubscribe route
  - `/backend/Gemfile` - Added letter_opener and sidekiq-scheduler gems
  - `/backend/spec/mailers/reminder_mailer_spec.rb` - Mailer specs (22 tests)
  - `/backend/spec/jobs/send_morning_planning_reminders_job_spec.rb` - Job specs (6 tests)
  - `/backend/spec/jobs/send_evening_reflection_reminders_job_spec.rb` - Job specs (4 tests)
  - `/backend/spec/jobs/send_weekly_review_reminders_job_spec.rb` - Job specs (5 tests)
  - `/backend/spec/jobs/send_goal_check_in_reminders_job_spec.rb` - Job specs (8 tests)
  - `/backend/spec/requests/api/v1/email_subscriptions_spec.rb` - Unsubscribe endpoint specs (8 tests)
- **Learnings for future iterations:**
  - Use sidekiq-scheduler gem for cron-based job scheduling in sidekiq.yml
  - Reminder jobs run every 5 minutes and check if current time is within 5-minute window of user's scheduled time
  - JWT tokens with 1-year expiry work well for unsubscribe links - encode user_id and reminder_type
  - Letter Opener in development mode opens emails in browser automatically
  - Email templates use table-based layout for better email client compatibility
  - Reminder jobs filter by both email channel (enabled) AND specific reminder type (enabled)
  - Goal check-in job filters for goals with status in (not_started, in_progress, at_risk) and due_date within 7 days
  - Prevent duplicate goal emails by checking Notification table for same goal_id same day
  - Use `find_each` for batch processing users to avoid loading all into memory
  - Split complex job methods into smaller private helpers (build_context, should_skip?, send_email) to satisfy ABC complexity
  - 638 total tests pass (53 new email notification tests)
---

## 2026-01-11 - US-022
- Implemented AI SMART Goal Refinement Backend with Anthropic Claude API integration
- Files created/changed:
  - `/backend/app/services/anthropic_client.rb` - Claude API client with error handling for Faraday errors
  - `/backend/app/services/goal_refinement_service.rb` - Service to generate SMART goal suggestions with structured JSON response
  - `/backend/app/controllers/api/v1/goals_controller.rb` - Added `refine` action for POST /api/v1/families/:family_id/goals/:id/refine
  - `/backend/app/policies/goal_policy.rb` - Added `refine?` policy method
  - `/backend/config/routes.rb` - Added refine member route to goals resource
  - `/backend/config/initializers/rack_attack.rb` - Rate limiting for AI refinement (10/user/hour, 5/IP/hour)
  - `/backend/config/application.rb` - Added Rack::Attack middleware
  - `/backend/Gemfile` - Added anthropic and rack-attack gems
  - `/backend/.rubocop.yml` - Adjusted RSpec cop limits for service specs
  - `/backend/spec/services/anthropic_client_spec.rb` - 7 tests for API client
  - `/backend/spec/services/goal_refinement_service_spec.rb` - 12 tests for refinement service
  - `/backend/spec/requests/api/v1/goals_spec.rb` - 19 new tests for refine endpoint
- **Learnings for future iterations:**
  - The alexrudall/anthropic gem (v0.4.1) uses Faraday errors, not custom Anthropic:: errors
  - Use Faraday::TooManyRequestsError for rate limiting, Faraday::BadRequestError for content filtering
  - Rack::Attack initializer: check if cache_store is Array before calling .first (it can be a Symbol)
  - When testing services that create other services in initialize, mock at the class level (allow(ServiceClass).to receive(:new))
  - Use instance_double for verified doubles, but use `double()` with rubocop:disable when no constant exists
  - GoalRefinementService returns structured hash with: smart_suggestions, alternative_titles, alternative_descriptions, potential_obstacles, milestones, overall_feedback
  - AI response parsing handles JSON in markdown code blocks (```json...```)
  - Break large heredocs into constants (SYSTEM_PROMPT, RESPONSE_FORMAT) to satisfy method length cops
  - 672 total tests pass (34 new AI refinement tests)
---

## 2026-01-12 - US-023
- Implemented AI SMART Goal Refinement Frontend with coaching interface
- Files created/changed:
  - `/frontend/src/components/AIRefinementPanel.tsx` - AI suggestions panel with organized sections for SMART criteria, titles, descriptions, obstacles, milestones
  - `/frontend/src/components/GoalModal.tsx` - Added AI Coach tab, defaultValues support, onCreateSubGoal callback
  - `/frontend/src/components/GoalDetailView.tsx` - Added onRefineWithAI callback
  - `/frontend/src/hooks/useGoals.ts` - Added useRefineGoal mutation hook
  - `/frontend/src/lib/goals.ts` - Added AI refinement types (GoalRefinementResponse, SmartSuggestions, Obstacle, Milestone) and refineGoal API
  - `/frontend/src/pages/Goals.tsx` - Added handleCreateSubGoal handler and pendingSubGoal state for milestone-to-subgoal flow
- **Learnings for future iterations:**
  - AI refinement panel uses purple theme (bg-purple-50, border-purple-200) for suggestion sections
  - Use dismissedSuggestions Set to track dismissed individual suggestions
  - Use createdMilestones Set to track which milestones have been converted to sub-goals
  - defaultValues prop on GoalModal enables pre-populating form when creating sub-goals from milestones
  - onCreateSubGoal callback flows: AIRefinementPanel -> GoalModal -> Goals.tsx (opens new modal with parent_id set)
  - MilestoneSubGoal interface has: title, description, suggestedProgress fields
  - Separate state (pendingSubGoal) needed to pass info from edit modal to create modal
---

## 2026-01-12 - US-024
- Implemented Gamification - Streaks Backend for tracking planning consistency
- Files created/changed:
  - `/backend/app/models/streak.rb` - Streak model with streak_type enum, current/longest counts, milestone detection, broken streak logic
  - `/backend/app/services/streak_service.rb` - Service for recording activities, getting all streaks, checking/resetting broken streaks
  - `/backend/app/controllers/api/v1/streaks_controller.rb` - GET /api/v1/users/me/streaks endpoint with at_risk and next_milestone
  - `/backend/app/controllers/api/v1/daily_plans_controller.rb` - Integrated streak recording on daily plan update
  - `/backend/app/controllers/api/v1/reflections_controller.rb` - Integrated streak recording on evening reflection create/update
  - `/backend/app/controllers/api/v1/weekly_reviews_controller.rb` - Integrated streak recording on weekly review completion
  - `/backend/app/models/user.rb` - Added has_many :streaks association
  - `/backend/config/routes.rb` - Added streaks resource under /users/me
  - `/backend/config/locales/en.yml` - Added validation message for duplicate streak type
  - `/backend/db/migrate/20260112061006_create_streaks.rb` - Migration with unique index on user_id + streak_type
  - `/backend/spec/factories/streaks.rb` - Factory with traits for all streak types and states
  - `/backend/spec/models/streak_spec.rb` - Model specs (28 tests)
  - `/backend/spec/services/streak_service_spec.rb` - Service specs (14 tests)
  - `/backend/spec/requests/api/v1/streaks_spec.rb` - Request specs (14 tests)
- **Learnings for future iterations:**
  - Streak types use integer enum: daily_planning=0, evening_reflection=1, weekly_review=2
  - record_activity! returns boolean (true if recorded, false if already done for period)
  - Weekly review streak uses 7-day period instead of 1-day for daily streaks
  - broken? method uses expected_gap (1 day for daily, 7 for weekly) plus optional grace_period
  - at_risk calculation: daily=true if haven't done today, weekly=true if 6+ days since last
  - Milestone thresholds: [7, 14, 30, 60, 90, 180, 365]
  - Controller integration: record streak when plan_has_content?, reflection.completed?, or weekly review just completed
  - 743 total tests pass (71 new streak-related tests)
---

## 2026-01-12 - US-025
- Implemented Gamification - Badges Backend for user achievement tracking
- Files created/changed:
  - `/backend/app/models/badge.rb` - Badge model with name, description, icon, category, criteria (jsonb), CATEGORIES constant
  - `/backend/app/models/user_badge.rb` - UserBadge join model with earned_at timestamp, auto-set via before_validation
  - `/backend/app/services/badge_service.rb` - BadgeService with check_all_badges, category-specific checks, award_badge methods
  - `/backend/app/controllers/api/v1/badges_controller.rb` - GET /api/v1/badges and GET /api/v1/users/me/badges endpoints
  - `/backend/config/routes.rb` - Added badges routes (index and user_badges under /users/me)
  - `/backend/db/migrate/20260112150000_create_badges.rb` - Badges table with unique name index
  - `/backend/db/migrate/20260112150001_create_user_badges.rb` - UserBadges join table with unique user_id+badge_id
  - `/backend/db/seeds/badges.rb` - Seed data for 10 initial badges across 4 categories
  - `/backend/db/seeds.rb` - Updated to load badge seeds
  - `/backend/config/locales/en.yml` - Added validation message for already_earned
  - `/backend/app/models/user.rb` - Added user_badges and badges associations
  - `/backend/spec/factories/badges.rb` - Factory with category and specific badge traits
  - `/backend/spec/factories/user_badges.rb` - Factory with recent/old traits
  - `/backend/spec/models/badge_spec.rb` - Model specs (16 tests)
  - `/backend/spec/models/user_badge_spec.rb` - Model specs (7 tests)
  - `/backend/spec/services/badge_service_spec.rb` - Service specs (15 tests)
  - `/backend/spec/requests/api/v1/badges_spec.rb` - Request specs (12 tests)
- **Learnings for future iterations:**
  - Badge categories: goals, planning, reflection, streaks, general
  - BadgeService uses dynamic method dispatch: #{badge.name}_eligible? for specific badges, generic_eligible? for fallback
  - Badge criteria stored as jsonb with "type" and threshold fields (count, days)
  - UserBadge before_validation callback sets earned_at, so presence validation can't use shoulda-matchers
  - User badges endpoint calls BadgeService.check_all_badges to auto-award newly eligible badges
  - NotificationService.notify_badge_earned sends badge earned notifications
  - Badge stats include total_badges, earned_badges, completion_percentage
  - 793 total tests pass (50 new badge-related tests)
---

## 2026-01-12 - US-026
- Implemented Gamification - Points Backend for user engagement tracking
- Files created/changed:
  - `/backend/app/models/points_ledger_entry.rb` - PointsLedgerEntry model with user_id, points, activity_type, metadata (jsonb)
  - `/backend/app/services/points_service.rb` - PointsService with award methods for all activity types and query methods
  - `/backend/app/controllers/api/v1/points_controller.rb` - GET /api/v1/users/me/points endpoint with total, weekly, breakdown, and recent activity
  - `/backend/app/controllers/api/v1/daily_plans_controller.rb` - Integrated task completion points (tracks which tasks changed to completed)
  - `/backend/app/controllers/api/v1/reflections_controller.rb` - Integrated reflection completion points
  - `/backend/app/controllers/api/v1/weekly_reviews_controller.rb` - Integrated weekly review completion points
  - `/backend/app/controllers/api/v1/goals_controller.rb` - Integrated goal creation and completion points
  - `/backend/app/services/badge_service.rb` - Added points for earning badges
  - `/backend/app/services/streak_service.rb` - Added points for streak milestones
  - `/backend/app/models/user.rb` - Added points_ledger_entries association and total_points/weekly_points methods
  - `/backend/config/routes.rb` - Added points route under /users/me
  - `/backend/db/migrate/20260112150002_create_points_ledger_entries.rb` - Migration with indexes
  - `/backend/spec/factories/points_ledger_entries.rb` - Factory with traits for all activity types
  - `/backend/spec/models/points_ledger_entry_spec.rb` - Model specs (14 tests)
  - `/backend/spec/services/points_service_spec.rb` - Service specs (24 tests)
  - `/backend/spec/requests/api/v1/points_spec.rb` - Request specs (13 tests)
- **Learnings for future iterations:**
  - Point values: complete_task=5, complete_daily_plan=10, complete_reflection=20, complete_weekly_review=50, create_goal=15, complete_goal=30, earn_badge=25, streak_milestone=50
  - PointsLedgerEntry stores metadata as jsonb for contextual information (task_id, goal_title, etc.)
  - Use Time.zone.now.all_day and Time.zone.now.all_week for Rails/ExpandedDateRange cop compliance
  - Track task completion state before update to detect newly completed tasks (avoid double-awarding)
  - Integrate points where streaks are already recorded (same trigger conditions)
  - Points endpoint returns total, this_week, breakdown by activity type, and recent_activity array
  - Use activity_label helper to convert activity_type to human-readable strings
  - 854 total tests pass (61 new points-related tests)
---

## 2026-01-12 - US-027
- Implemented Gamification - Family Leaderboard with backend and frontend
- Files created/changed:
  - `/backend/app/services/leaderboard_service.rb` - LeaderboardService with weekly/all-time scopes, ranking logic, streak/badge aggregation
  - `/backend/app/controllers/api/v1/leaderboards_controller.rb` - GET /api/v1/families/:id/leaderboard endpoint
  - `/backend/config/routes.rb` - Added leaderboard resource under families
  - `/backend/spec/services/leaderboard_service_spec.rb` - Service specs (10 tests)
  - `/backend/spec/requests/api/v1/leaderboards_spec.rb` - Request specs (9 tests)
  - `/frontend/src/lib/leaderboard.ts` - API functions, types, and helper utilities
  - `/frontend/src/hooks/useLeaderboard.ts` - TanStack Query hook for leaderboard data
  - `/frontend/src/pages/Leaderboard.tsx` - Family leaderboard page with member cards, top performer spotlight, scope tabs
  - `/frontend/src/App.tsx` - Added /families/:id/leaderboard route
  - `/frontend/src/pages/FamilySettings.tsx` - Added Leaderboard button link
- **Learnings for future iterations:**
  - LeaderboardService uses PointsService.total_points and PointsService.weekly_points for scope-based points calculation
  - Ranking handles ties by giving same rank and sorting alphabetically within ties
  - Top performer is first entry in sorted leaderboard (highest points)
  - Encouragement messages vary by rank position (1st="Leading", 2nd="So close", etc.)
  - MemberCard displays avatar with initial fallback, rank badge, points, streak breakdown, badge count
  - Use index_by(&:streak_type) to convert streak array to hash for easy lookup
  - Reuse existing FamilyPolicy :show? for leaderboard authorization (members can view)
  - 875 total tests pass (21 new leaderboard tests)
---
