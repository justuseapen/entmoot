# Ralph Progress Log
Started: Thu Jan 15 09:15:55 EST 2026
---

## Codebase Patterns
- All model files must start with `# frozen_string_literal: true`
- Use double quotes for strings in Ruby
- Run migrations from `/Users/justuseapen/Dropbox/code/entmoot/backend` directory
- Use `bundle exec rails db:migrate` and `bundle exec rspec` from backend directory
- Frontend types in `frontend/src/lib/*.ts`, hooks in `frontend/src/hooks/*.ts`
- TanStack Query hooks use query keys pattern: `const xxxKeys = { all: ["xxx"], list: (id) => [...] }`
- Run frontend typecheck with `npm run build` from frontend directory
---

## 2026-01-15 09:18 - US-001
- **What was implemented:** Created Habit and HabitCompletion models with migrations
- **Files changed:**
  - `backend/db/migrate/20260115141634_create_habits.rb` - habits table with name, position, is_active, user_id, family_id
  - `backend/db/migrate/20260115141642_create_habit_completions.rb` - habit_completions table with habit_id, daily_plan_id, completed
  - `backend/app/models/habit.rb` - Habit model with associations and validations
  - `backend/app/models/habit_completion.rb` - HabitCompletion model with associations
  - `backend/app/models/daily_plan.rb` - Added has_many :habit_completions
  - `backend/db/schema.rb` - Updated schema
- **Learnings for future iterations:**
  - Unique indexes were added to prevent duplicate habits per user/family/position and duplicate completions per habit/daily_plan
  - The DailyPlan model is the central model for daily planning features
  - All 1613 backend tests pass after changes
---

## 2026-01-15 09:25 - US-002
- **What was implemented:** Created HabitInitializerService to seed default habits for users
- **Files changed:**
  - `backend/app/services/habit_initializer_service.rb` - Service to create 9 default habits with sequential positions (1-9)
  - `backend/app/models/daily_plan.rb` - Integrated HabitInitializerService.initialize_habits_for in find_or_create_for_today
  - `backend/app/models/user.rb` - Added has_many :habits association
- **Learnings for future iterations:**
  - Service classes use class methods (class << self pattern) for stateless operations
  - The HabitInitializerService is idempotent - checks user.habits.exists?(family: family) before creating
  - Use `exists?(family: family)` instead of `where(family: family).exists?` (Rails/WhereExists rubocop rule)
  - All 1613 backend tests continue to pass
---

## 2026-01-15 09:45 - US-003
- **What was implemented:** Added habits API endpoints and updated daily_plans to support habit_completions
- **Files changed:**
  - `backend/app/controllers/api/v1/habits_controller.rb` - New controller with index action
  - `backend/app/policies/habit_policy.rb` - New policy with index? allowing family members
  - `backend/config/routes.rb` - Added habits route under families namespace
  - `backend/app/controllers/api/v1/daily_plans_controller.rb` - Added habit_completions_attributes to permitted params and response
  - `backend/app/models/daily_plan.rb` - Added accepts_nested_attributes_for :habit_completions
  - `backend/spec/factories/habits.rb` - New factory for Habit
  - `backend/spec/factories/habit_completions.rb` - New factory for HabitCompletion
  - `backend/spec/requests/api/v1/habits_spec.rb` - New request specs (8 tests)
- **Learnings for future iterations:**
  - HabitPolicy uses `user.member_of?(record)` where record is the Family passed to authorize
  - The daily_plans_controller includes habit_completions with nested habit data in responses
  - Use `includes(:habit)` when mapping habit_completions to avoid N+1 queries
  - All 1621 backend tests pass (8 new tests added)
---

## 2026-01-15 09:52 - US-004
- **What was implemented:** Added shutdown_shipped and shutdown_blocked columns to daily_plans for end-of-day reflection notes
- **Files changed:**
  - `backend/db/migrate/20260115142619_add_shutdown_notes_to_daily_plans.rb` - Migration adding shutdown_shipped and shutdown_blocked text columns
  - `backend/app/controllers/api/v1/daily_plans_controller.rb` - Updated daily_plan_params to permit new params, updated plan_attributes to include them in response
  - `backend/db/schema.rb` - Updated schema
- **Learnings for future iterations:**
  - The daily_plan_params method centralizes permitted params - add new fields there
  - The plan_attributes method builds the response hash - add new fields there for API response
  - Simple column additions just need: migration + permit params + include in response
  - All 1621 backend tests continue to pass
---

## 2026-01-15 10:05 - US-005
- **What was implemented:** Updated frontend TypeScript types for habits and shutdown notes
- **Files changed:**
  - `frontend/src/lib/dailyPlans.ts` - Added Habit, HabitCompletion, HabitCompletionAttributes types; added shutdown_shipped, shutdown_blocked, habit_completions to DailyPlan type; added getHabits API function
  - `frontend/src/hooks/useHabits.ts` - New hook with TanStack Query for fetching user's habits
- **Learnings for future iterations:**
  - Frontend types mirror backend API responses - include all fields returned by the controller
  - TanStack Query hooks follow the pattern: query keys object + useQuery with enabled condition
  - Use `@/lib/` for API functions and `@/hooks/` for query hooks
  - The useAuthStore provides `isAuthenticated` for gating queries
  - Typecheck with `npm run build` from frontend directory
---

## 2026-01-15 10:40 - US-006
- **What was implemented:** Redesigned Top 3 Outcomes section with goal linking capability
- **Files changed:**
  - `frontend/src/pages/DailyPlanner.tsx` - Renamed section, added subtitle, added goal selector dropdown with filtering, added badge display for linked goals
- **Learnings for future iterations:**
  - Use shadcn Select component for dropdowns, imports: Select, SelectContent, SelectItem, SelectTrigger
  - Filter goals by time_scale with `goals?.filter((g) => g.time_scale !== "daily")`
  - TopPriority type already has goal_id and goal fields for linking to goals
  - Badge component from `@/components/ui/badge` for displaying tags
  - getTimeScaleLabel from `@/lib/goals` converts time_scale enum to human-readable label
  - Radix Select uses portals for dropdowns - won't appear in accessibility snapshots during browser testing
---
