# Ralph Progress Log
Started: Tue Jan 20 16:20:13 EST 2026

## Codebase Patterns
- SelectTrigger components need explicit width/height when used as icon-only buttons - default styles assume text content
- Use `w-11` (44px) minimum for touch targets on mobile to meet iOS accessibility guidelines
- Use `aria-label` for icon-only interactive elements
- Migrations are excluded from rubocop via `.rubocop.yml` - no need to worry about method length for migrations
- When adding nullable boolean fields intentionally (e.g., for "unanswered" state), rubocop will warn but can be ignored in migrations

---

## 2026-01-20 - US-001: Fix goal link button clickability in Daily Planner
- What was implemented: Fixed SelectTrigger clickability by adjusting size and padding
- Files changed: frontend/src/pages/DailyPlanner.tsx
- **Learnings for future iterations:**
  - The shadcn SelectTrigger with `size="sm"` reduces height to h-8, which combined with narrow width can make buttons hard to click
  - When using Select components as icon-only buttons, remove size prop and explicitly set dimensions
  - w-10 (40px) with px-3 padding leaves only ~16px for content, not enough for two icons (Link2 + chevron)
  - Touch target minimum: 44x44px for iOS, achieved with `h-10 w-11`
---

## 2026-01-20 - US-002: Add new fields to WeeklyReview model for template sections
- What was implemented: Created migration to add 21 new fields to weekly_reviews table
- Files changed:
  - backend/db/migrate/20260120212323_add_template_fields_to_weekly_reviews.rb (new)
  - backend/db/schema.rb (auto-updated)
- **Learnings for future iterations:**
  - The weekly_reviews table now has both old jsonb columns (wins, challenges, next_week_priorities, lessons_learned) AND new text columns (wins_shipped, losses_friction, weekly_priorities, kill_list) - these coexist for backward compatibility
  - System health check booleans (daily_focus_used_every_day, weekly_priorities_clear, cleaning_system_held, training_volume_sustainable) are intentionally nullable - nil means "not answered yet"
  - Forward setup booleans (workouts_blocked, monday_top_3_decided, monday_focus_card_prepped) default to false with NOT NULL
  - walks_planned and house_resets_planned default to 7 (days in a week)
---

## 2026-01-20 - US-003: Update WeeklyReview API to support new fields
- What was implemented: Updated controller to permit and serialize all 21 new template fields
- Files changed:
  - backend/app/controllers/api/v1/weekly_reviews_controller.rb
  - backend/spec/requests/api/v1/weekly_reviews_spec.rb
- **Learnings for future iterations:**
  - Rails `permit()` requires array params (e.g., `wins: []`) to come AFTER scalar params, otherwise syntax error
  - Refactored controller into PERMITTED_SCALAR_PARAMS/PERMITTED_ARRAY_PARAMS constants and helper methods to stay under rubocop line limits
  - API response organized into helper methods: base_attributes, legacy_attributes, template_attributes (with sub-methods for each section)
  - Use `include()` matcher with hash args for concise multi-field assertions in specs
  - Use `:aggregate_failures` tag on specs with many expectations to satisfy RSpec/MultipleExpectations cop
---

## 2026-01-20 - US-004: Update frontend WeeklyReview type
- What was implemented: Updated TypeScript types for WeeklyReview and UpdateWeeklyReviewData to include all 21 new template fields
- Files changed:
  - frontend/src/lib/weeklyReviews.ts
- **Learnings for future iterations:**
  - WeeklyReview type fields match backend snake_case naming (API returns snake_case)
  - Use `| null` for nullable fields from database (e.g., `boolean | null` for system health check booleans that can be unanswered)
  - Forward setup booleans (workouts_blocked, monday_top_3_decided, monday_focus_card_prepped) are non-nullable since they have NOT NULL default false in DB
  - UpdateWeeklyReviewData uses optional properties (`?`) since not all fields need to be sent on every update
  - useWeeklyReview hook didn't need changes - it already properly uses the types from weeklyReviews.ts
---

## 2026-01-20 - US-005: Create new WeeklyReview UI - Section 0: Source Review
- What was implemented: Added Section 0 card with source review reminder and daily plan links
- Files changed:
  - backend/app/controllers/api/v1/weekly_reviews_controller.rb (added daily_plans to API response)
  - frontend/src/lib/weeklyReviews.ts (added DailyPlanSummary type)
  - frontend/src/pages/WeeklyReview.tsx (added Section 0 component)
- **Learnings for future iterations:**
  - The WeeklyReview model already has a `daily_plans` method that queries DailyPlan for the week's date range
  - When displaying calendar grids, use `grid-cols-2 sm:grid-cols-4 lg:grid-cols-7` for responsive 7-day layouts
  - Use `toISOString().split("T")[0]` to compare dates in YYYY-MM-DD format
  - The Checkbox component from shadcn accepts `onCheckedChange` (not `onChange`) and passes a `CheckedState` type
  - Section 0 uses amber color scheme (border-amber-200, bg-amber-50/50) to distinguish it from other sections
---

## 2026-01-20 - US-006: Create Section 1: Review (Evidence-based)
- What was implemented: Added Section 1 card with wins_shipped and losses_friction textareas with auto-save on blur
- Files changed:
  - frontend/src/pages/WeeklyReview.tsx
- **Learnings for future iterations:**
  - Section 1 follows the same pattern as Section 0 but without the amber styling (uses default card styling)
  - The ClipboardList icon from lucide-react is used for the section header
  - Auto-save pattern uses `onBlur` callback with `useCallback` that calls `updateReview.mutateAsync`
  - Textarea components accept standard `onChange` (not `onCheckedChange` like Checkbox)
  - State variables follow naming pattern: camelCase for React state (winsShipped), snake_case for API fields (wins_shipped)
---

## 2026-01-20 - US-007: Create Section 2: Metrics Snapshot
- What was implemented: Added Section 2 card with metrics input pairs, percentage display, meals prepped toggle, and notes textarea
- Files changed:
  - frontend/src/pages/WeeklyReview.tsx
- **Learnings for future iterations:**
  - Used inline MetricRow component for cleaner code - each row has completed/planned inputs and percentage display
  - parseNumberInput helper converts empty string to null for proper API handling
  - calcPercentage helper returns null if either completed or planned is null (so percentage is only shown when both values exist)
  - For Y/N toggles, use paired Buttons with conditional styling instead of Checkbox
  - Color-coded percentages: green ≥80%, yellow ≥50%, red <50%
  - The Activity icon from lucide-react fits the metrics/tracking theme
  - Type MetricsNumberField was defined inline using union type for type safety on blur handlers
---

## 2026-01-20 - US-008: Create Section 3: System Health Check
- What was implemented: Added Section 3 card with Y/N toggle buttons for 4 health check questions and conditional textarea
- Files changed:
  - frontend/src/pages/WeeklyReview.tsx
- **Learnings for future iterations:**
  - HeartPulse icon from lucide-react fits the health check theme well
  - Reused Y/N toggle pattern from Section 2 (meals_prepped_held) but created HealthCheckQuestion inline component for cleaner code
  - Conditional rendering with `hasAnyNo` check: textarea only appears when at least one answer is false (not null)
  - SystemHealthField type union ensures type safety for the 4 boolean fields
  - Auto-save happens immediately on button click (onChange), not on blur, since buttons don't have blur events
  - The system_to_adjust textarea uses onBlur for auto-save (same pattern as other textareas)
  - Rose color scheme (text-rose-600) for the section header to distinguish from other sections
---

## 2026-01-20 - US-009: Create Section 4: This Week's Priorities
- What was implemented: Added Section 4 card with 5 numbered priority inputs and optional quarterly goal linking
- Files changed:
  - frontend/src/pages/WeeklyReview.tsx
- **Learnings for future iterations:**
  - Priorities stored in `weekly_priorities` field as newline-separated "text|goalId" format (e.g., "Write blog post|42\nReview code")
  - Used native HTML select element (not shadcn Select) for goal dropdown - simpler and avoids SelectTrigger sizing issues
  - useGoals hook with `time_scale: "quarterly"` filter to fetch only quarterly goals
  - Goal type must be imported with `import type { Goal }` due to `verbatimModuleSyntax` in tsconfig
  - Target icon and indigo color theme for priorities section
  - PriorityRow inline component for cleaner code - each row has number badge, input, dropdown, and optional badge
  - Goal link changes save immediately (unlike text blur) since dropdown change is a discrete action
  - Link2 icon from lucide-react used for the linked goal badge
---
