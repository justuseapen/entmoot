name: Deploy to Staging

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip running tests (use with caution)"
        required: false
        type: boolean
        default: false

concurrency:
  group: staging-deployment
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/backend
  STAGING_URL: https://staging.entmoot.app

jobs:
  test:
    name: Run Tests
    if: ${{ !inputs.skip_tests }}
    uses: ./.github/workflows/ci.yml

  build:
    name: Build Images
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    uses: ./.github/workflows/build-and-push.yml
    secrets: inherit

  deploy-staging:
    name: Deploy to Staging
    needs: [build]
    if: always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: ${{ env.STAGING_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger Coolify Deployment
        id: coolify_deploy
        run: |
          echo "Triggering Coolify deployment for staging..."

          # Trigger the webhook
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.COOLIFY_STAGING_WEBHOOK_URL }}" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "sha": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "image_tag": "staging"
            }' || echo "CURL_FAILED")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "Response code: $HTTP_CODE"
          echo "Response body: $BODY"

          if [[ "$HTTP_CODE" != "200" && "$HTTP_CODE" != "201" && "$HTTP_CODE" != "202" ]]; then
            echo "::warning::Coolify webhook returned status $HTTP_CODE. Deployment may still proceed."
          fi

      - name: Wait for deployment to start
        run: |
          echo "Waiting for deployment to initialize..."
          sleep 30

      - name: Health check
        id: health_check
        run: |
          echo "Running health checks on staging..."

          for i in {1..15}; do
            echo "Attempt $i of 15..."

            RESPONSE=$(curl -s -w "\n%{http_code}" "${{ env.STAGING_URL }}/health" || echo "CURL_FAILED")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n-1)

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "Health check passed!"
              echo "Response: $BODY"
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "Health check failed (HTTP $HTTP_CODE). Retrying in 10 seconds..."
            sleep 10
          done

          echo "::error::Staging health check failed after 15 attempts"
          echo "healthy=false" >> $GITHUB_OUTPUT
          exit 1

      - name: Update deployment status - Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              target_url: '${{ env.STAGING_URL }}',
              description: 'Staging deployment successful',
              context: 'Staging Environment'
            })

      - name: Update deployment status - Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'failure',
              description: 'Staging deployment failed',
              context: 'Staging Environment'
            })

      - name: Post deployment summary
        if: always()
        run: |
          echo "## Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging URL | [${{ env.STAGING_URL }}](${{ env.STAGING_URL }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Status | ${{ steps.health_check.outputs.healthy == 'true' && 'Healthy' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
