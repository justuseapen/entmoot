name: Trigger Staging Deploy

on:
  workflow_dispatch:

env:
  STAGING_URL: https://staging.entmoot.app

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: ${{ env.STAGING_URL }}

    steps:
      - name: Trigger Coolify Deployment
        run: |
          echo "Triggering Coolify deployment for staging..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.COOLIFY_STAGING_WEBHOOK_URL }}" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "sha": "${{ github.sha }}",
              "branch": "master",
              "image_tag": "staging"
            }' || echo "CURL_FAILED")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "Response code: $HTTP_CODE"
          echo "Response body: $BODY"

          if [[ "$HTTP_CODE" != "200" && "$HTTP_CODE" != "201" && "$HTTP_CODE" != "202" ]]; then
            echo "::warning::Coolify webhook returned status $HTTP_CODE"
          fi

      - name: Wait for deployment
        run: sleep 45

      - name: Health check
        run: |
          for i in {1..10}; do
            echo "Health check attempt $i..."
            if curl -sf "${{ env.STAGING_URL }}/health"; then
              echo "Health check passed!"
              exit 0
            fi
            sleep 10
          done
          echo "::error::Health check failed"
          exit 1
